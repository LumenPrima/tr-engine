openapi: 3.0.3
info:
  title: tr-engine API
  version: 0.7.2
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  description: |
    Backend service for trunk-recorder data ingestion and querying.
    Provides REST APIs for accessing radio system data, calls, talkgroups,
    units, and recorder state.

    ## Data Model: Systems and Sites

    The data model separates **logical radio networks** from **recording
    sites**:

    - **System** (`system_id`): a logical radio network. For P25, this
      is the WACN-level network identified by `(sysid, wacn)`. For
      conventional, it is identified by `(instance_id, sys_name)`.
      Talkgroups and units belong to the system level because they are
      shared across all sites on the same P25 network.

    - **Site** (`site_id`): a recording point within a system. Each
      TR `sys_name` entry within an instance creates a site. For P25,
      different sites on the same network are distinguished by
      `(nac, rfss, site_id)`. A single system may have many sites
      (e.g., "butco" nac=340 and "warco" nac=34D are both sites on
      the same P25 sysid=348 network). Call recordings belong to a
      specific site.

    Example:
    ```
    System 1 (P25 sysid=348, wacn=BEE00)
      ├── Site 1 "butco"  (nac=340, rfss=4, p25_site=1)
      ├── Site 2 "warco"  (nac=34D, rfss=1, p25_site=13)
      ├── Talkgroups (shared across all sites)
      └── Units (shared across all sites)
    ```

    For conventional systems, the hierarchy is 1:1 — each system has
    exactly one site.

    Identity resolution at ingest (from MQTT `systems` message):
    - **System**: match by `(sysid, wacn)` for P25, or
      `(instance_id, sys_name)` for conventional.
    - **Site**: match by `(system_id, instance_id, sys_name)`. The
      `sys_name` (not `sys_num`) is used because `sys_num` is a
      positional index in the TR config that shifts when systems are
      added or reordered.

    This means cloning a TR config to a second box and pointing it at
    the same P25 system "just works" — both instances contribute
    recordings to the same system_id (shared talkgroups/units), each
    as a distinct site, with call groups handling deduplication.

    ## ID Formats

    - **Call ID**: database auto-increment integer (e.g., `48531`).
      Unique per recording. Opaque — clients should not parse or
      construct call IDs.
    - **Talkgroup ID**: `{system_id}:{tgid}` (e.g., `1:9178`) or plain
      `{tgid}` if unambiguous across systems.
    - **Unit ID**: `{system_id}:{unit_id}` (e.g., `1:924003`) or plain
      `{unit_id}` if unambiguous.
    - **Call Group key**: derived from `(system_id, tgid, start_unix)`.
      Multiple recordings of the same transmission (possibly from
      different sites) are grouped automatically.

    When a plain (non-composite) talkgroup or unit ID matches multiple
    systems, the API returns **409 Conflict** with the list of matching
    systems so the client can disambiguate.

    ## Pagination

    All list endpoints return:
    - `total`: total matching results across all pages
    - `limit`: page size used
    - `offset`: starting position

    ## Embedded Context

    List and detail responses embed human-readable names (system_name,
    site_short_name, talkgroup alpha_tag/description, unit alpha_tag) to
    minimize client-side lookup tables. Clients should not need to maintain
    in-memory cross-reference maps for display purposes.

servers:
  - url: /api/v1
    description: Default API base path

security:
  - bearerAuth: []

tags:
  - name: health
    description: Service health
  - name: systems
    description: Radio system and recording site operations
  - name: talkgroups
    description: Talkgroup operations
  - name: units
    description: Radio unit operations
  - name: calls
    description: Call recording operations
  - name: call-groups
    description: Deduplicated call group operations
  - name: stats
    description: System statistics and metrics
  - name: recorders
    description: Trunk-recorder hardware state
  - name: events
    description: Real-time event streaming (SSE)
  - name: transcriptions
    description: Transcription access, search, and management
  - name: admin
    description: Administrative operations (system merge, cleanup)

# ============================================================
# PATHS
# ============================================================
paths:

  # ----------------------------------------------------------
  # Health
  # ----------------------------------------------------------
  /health:
    get:
      operationId: getHealth
      summary: Health check
      description: Returns service health status. No authentication required.
      tags: [health]
      security: []
      responses:
        "200":
          description: Healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "503":
          description: Unhealthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  # ----------------------------------------------------------
  # Systems
  # ----------------------------------------------------------
  /systems:
    get:
      operationId: listSystems
      summary: List systems
      description: |
        Returns all logical radio systems. Each system contains its
        recording sites. For P25, a system represents the WACN-level
        network (which may span multiple sites like "butco" and "warco").
        For conventional, each system has exactly one site.
      tags: [systems]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SystemListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /systems/{id}:
    get:
      operationId: getSystem
      summary: Get a system
      description: Returns a single system by its database ID, with embedded sites.
      tags: [systems]
      parameters:
        - name: id
          in: path
          required: true
          description: System database ID
          schema:
            type: integer
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/System"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    patch:
      operationId: updateSystem
      summary: Update system metadata
      description: |
        Updates system-level fields. For P25, this includes the network
        identity (sysid, wacn). Use PATCH /sites/{id} to update
        site-level fields (short_name, nac, etc.).
      tags: [systems]
      parameters:
        - name: id
          in: path
          required: true
          description: System database ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SystemPatch"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/System"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /sites/{id}:
    get:
      operationId: getSite
      summary: Get a recording site
      description: Returns a single recording site by its database ID.
      tags: [systems]
      parameters:
        - name: id
          in: path
          required: true
          description: Site database ID
          schema:
            type: integer
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Site"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    patch:
      operationId: updateSite
      summary: Update site metadata
      description: |
        Updates site-level fields. Changing `short_name` or `instance_id`
        updates the ingest lookup key — future MQTT messages with the new
        name will map to this site. Update the trunk-recorder config to
        match, or messages with the old name will create a new site
        (fragmentation).
      tags: [systems]
      parameters:
        - name: id
          in: path
          required: true
          description: Site database ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SitePatch"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Site"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: short_name + instance_id conflicts with an existing site
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          $ref: "#/components/responses/InternalError"

  /p25-systems:
    get:
      operationId: listP25Systems
      summary: List P25 systems (grouped by network)
      description: |
        Returns P25 systems grouped by sysid + wacn. Each P25 system may have
        multiple recording sites (trunk-recorder instances monitoring different
        NACs on the same network). Use this when you need a logical network view
        rather than a per-site view.
      tags: [systems]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/P25SystemListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Talkgroups
  # ----------------------------------------------------------
  /talkgroups:
    get:
      operationId: listTalkgroups
      summary: List talkgroups
      description: |
        Returns talkgroups with embedded stats (call_count, calls_1h, calls_24h,
        unit_count). Supports filtering by system (database ID or P25 SYSID),
        group category, and free-text search. Search results include a
        relevance_score (100=exact, 50=prefix, 10=contains).
      tags: [talkgroups]
      parameters:
        - name: system_id
          in: query
          description: Filter by system database ID (comma-separated for multiple)
          schema:
            type: string
            example: "1,2"
        - name: sysid
          in: query
          description: Filter by P25 SYSID (comma-separated for multiple, e.g., "348,34D")
          schema:
            type: string
        - name: group
          in: query
          description: Filter by talkgroup group/category (e.g., "Fire", "Law Dispatch")
          schema:
            type: string
        - name: search
          in: query
          description: Search by alpha_tag, tgid, group, tag, or description
          schema:
            type: string
        - $ref: "#/components/parameters/sort"
        - $ref: "#/components/parameters/sortDir"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TalkgroupListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /talkgroups/{id}:
    get:
      operationId: getTalkgroup
      summary: Get a talkgroup
      description: |
        Returns a single talkgroup with stats. Accepts composite `system_id:tgid`
        format (e.g., "1:9178") or plain `tgid`. Returns 409 if a plain tgid
        is ambiguous across systems.
      tags: [talkgroups]
      parameters:
        - $ref: "#/components/parameters/talkgroupId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Talkgroup"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Ambiguous"
        "500":
          $ref: "#/components/responses/InternalError"

    patch:
      operationId: updateTalkgroup
      summary: Update talkgroup metadata
      description: |
        Updates mutable talkgroup fields (alpha_tag, description, group,
        tag, priority). Only provided fields are changed.
      tags: [talkgroups]
      parameters:
        - $ref: "#/components/parameters/talkgroupId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TalkgroupPatch"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Talkgroup"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Ambiguous"
        "500":
          $ref: "#/components/responses/InternalError"

  /talkgroups/{id}/calls:
    get:
      operationId: listTalkgroupCalls
      summary: List calls for a talkgroup
      description: |
        Returns calls for a specific talkgroup. Accepts composite `system_id:tgid`
        or plain `tgid`.
      tags: [talkgroups]
      parameters:
        - $ref: "#/components/parameters/talkgroupId"
        - $ref: "#/components/parameters/startTime"
        - $ref: "#/components/parameters/endTime"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CallListResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Ambiguous"
        "500":
          $ref: "#/components/responses/InternalError"

  /talkgroups/{id}/units:
    get:
      operationId: listTalkgroupUnits
      summary: List units affiliated with a talkgroup
      description: |
        Returns units that have recent activity on this talkgroup, based on
        call participation and affiliation events.
      tags: [talkgroups]
      parameters:
        - $ref: "#/components/parameters/talkgroupId"
        - name: window
          in: query
          description: Activity window in minutes (1-1440)
          schema:
            type: integer
            default: 60
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnitListResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Ambiguous"
        "500":
          $ref: "#/components/responses/InternalError"

  /talkgroups/encryption-stats:
    get:
      operationId: getTalkgroupEncryptionStats
      summary: Get encryption stats per talkgroup
      description: |
        Returns counts of encrypted vs clear calls per talkgroup from recent
        activity. Includes talkgroup display names.
      tags: [talkgroups]
      parameters:
        - name: hours
          in: query
          description: Hours of history to include
          schema:
            type: integer
            default: 24
        - name: sysid
          in: query
          description: Filter by P25 SYSID
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EncryptionStatsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Talkgroup Directory
  # ----------------------------------------------------------
  /talkgroup-directory:
    get:
      operationId: listTalkgroupDirectory
      summary: Search talkgroup reference directory
      description: |
        Searches the talkgroup directory — a reference table imported from
        trunk-recorder's talkgroup CSV files via TR_DIR auto-discovery or
        CSV upload. Separate from the main talkgroups endpoint, which only
        contains talkgroups actually heard on the air.
      tags: [talkgroups]
      parameters:
        - name: system_id
          in: query
          description: Filter by system ID (repeatable)
          schema:
            type: integer
        - name: search
          in: query
          description: Full-text search across alpha_tag, description, tag, category
          schema:
            type: string
        - name: category
          in: query
          description: Filter by category
          schema:
            type: string
        - name: mode
          in: query
          description: Filter by mode (D, A, E, M)
          schema:
            type: string
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  talkgroups:
                    type: array
                    items:
                      $ref: "#/components/schemas/TalkgroupDirectoryEntry"
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /talkgroup-directory/import:
    post:
      operationId: importTalkgroupDirectory
      summary: Upload talkgroup CSV
      description: |
        Imports a trunk-recorder talkgroup CSV file into the talkgroup directory.
        Accepts either `system_id` (must exist) or `system_name` (creates the
        system if it doesn't exist). CSV format: Decimal, Hex, Alpha Tag, Mode,
        Description, Tag, Category (header-aware, column order doesn't matter).
      tags: [talkgroups]
      parameters:
        - name: system_id
          in: query
          description: Target system ID (must exist). Mutually exclusive with system_name.
          schema:
            type: integer
        - name: system_name
          in: query
          description: Target system name (created if it doesn't exist). Mutually exclusive with system_id.
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: Talkgroup CSV file
      responses:
        "200":
          description: Import successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  imported:
                    type: integer
                    description: Number of talkgroups successfully imported
                  total:
                    type: integer
                    description: Total valid rows in the CSV
                  system_id:
                    type: integer
                    description: System ID the talkgroups were imported into
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Units
  # ----------------------------------------------------------
  /units:
    get:
      operationId: listUnits
      summary: List radio units
      description: |
        Returns radio units with optional filters. When searching, results
        include relevance_score (100=exact, 50=prefix, 10=contains).
      tags: [units]
      parameters:
        - name: sysid
          in: query
          description: Filter by P25 SYSID
          schema:
            type: string
        - name: search
          in: query
          description: Search by alpha_tag or unit_id
          schema:
            type: string
        - name: active_within
          in: query
          description: |
            Only return units active within this many minutes. Replaces the
            need for a separate "active units" endpoint when combined with
            other filters.
          schema:
            type: integer
        - name: talkgroup
          in: query
          description: Filter by talkgroup ID (comma-separated for multiple)
          schema:
            type: string
            example: "9178,5344"
        - $ref: "#/components/parameters/sort"
        - $ref: "#/components/parameters/sortDir"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnitListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /units/{id}:
    get:
      operationId: getUnit
      summary: Get a unit
      description: |
        Returns a single unit. Accepts composite `system_id:unit_id` (e.g.,
        "1:1234567") or plain `unit_id`. Returns 409 if ambiguous.
      tags: [units]
      parameters:
        - $ref: "#/components/parameters/unitId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unit"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Ambiguous"
        "500":
          $ref: "#/components/responses/InternalError"

    patch:
      operationId: updateUnit
      summary: Update unit metadata
      description: Updates mutable unit fields (alpha_tag, alpha_tag_source).
      tags: [units]
      parameters:
        - $ref: "#/components/parameters/unitId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UnitPatch"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Unit"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Ambiguous"
        "500":
          $ref: "#/components/responses/InternalError"

  /units/{id}/calls:
    get:
      operationId: listUnitCalls
      summary: List calls for a unit
      description: |
        Returns calls that include transmissions from a specific unit.
        Accepts composite `system_id:unit_id` or plain `unit_id`.
      tags: [units]
      parameters:
        - $ref: "#/components/parameters/unitId"
        - $ref: "#/components/parameters/startTime"
        - $ref: "#/components/parameters/endTime"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CallListResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Ambiguous"
        "500":
          $ref: "#/components/responses/InternalError"

  /units/{id}/events:
    get:
      operationId: listUnitEvents
      summary: List unit events
      description: |
        Returns events (affiliations, registrations, calls, etc.) for a
        specific unit. Includes embedded talkgroup and unit display names.
      tags: [units]
      parameters:
        - $ref: "#/components/parameters/unitId"
        - name: type
          in: query
          description: Filter by event type
          schema:
            $ref: "#/components/schemas/EventType"
        - name: talkgroup
          in: query
          description: Filter by talkgroup ID
          schema:
            type: integer
        - $ref: "#/components/parameters/startTime"
        - $ref: "#/components/parameters/endTime"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnitEventListResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Ambiguous"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Unit Events (system-wide)
  # ----------------------------------------------------------
  /unit-events:
    get:
      operationId: listUnitEventsGlobal
      summary: List unit events (system-wide)
      description: |
        Returns unit events across an entire system with JOINs for display
        names. Supports multi-type filtering and optional emergency filter.
        Default lookback is 1 hour; max time range is 24 hours.
      tags: [units]
      parameters:
        - name: system_id
          in: query
          description: Filter by internal system ID (comma-separated for multiple)
          schema:
            type: string
            example: "1,2"
        - name: sysid
          in: query
          description: Filter by P25 sysid hex (comma-separated for multiple)
          schema:
            type: string
        - name: unit_id
          in: query
          description: Filter by unit radio ID (comma-separated for multiple)
          schema:
            type: string
            example: "924003,104"
        - name: type
          in: query
          description: |
            Comma-separated event types to include (e.g. `join,on,off`).
            If omitted, all event types are returned.
          schema:
            type: string
        - name: tgid
          in: query
          description: Filter by talkgroup ID (comma-separated for multiple)
          schema:
            type: string
            example: "9178,5344"
        - name: emergency
          in: query
          description: Filter by emergency flag
          schema:
            type: boolean
        - $ref: "#/components/parameters/startTime"
        - $ref: "#/components/parameters/endTime"
        - name: sort
          in: query
          description: |
            Sort field with optional `-` prefix for descending.
            Allowed: `time`, `unit_rid`, `tgid`, `event_type`. Default: `-time`.
          schema:
            type: string
            default: "-time"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnitEventListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Unit Affiliations (live in-memory state)
  # ----------------------------------------------------------
  /unit-affiliations:
    get:
      operationId: listUnitAffiliations
      summary: List live talkgroup affiliations
      description: |
        Returns current talkgroup affiliation state for units, derived from
        live MQTT `join` and `off` events. The map starts empty on boot and
        populates from live traffic.

        Each entry shows which talkgroup a unit is currently affiliated with,
        when the affiliation started, and the unit's status (`affiliated` or `off`).
      tags: [units]
      parameters:
        - name: system_id
          in: query
          description: Filter by internal system ID (comma-separated for multiple)
          schema:
            type: string
            example: "1,2"
        - name: sysid
          in: query
          description: Filter by P25 sysid hex (comma-separated for multiple)
          schema:
            type: string
        - name: tgid
          in: query
          description: Filter by talkgroup ID (comma-separated for multiple)
          schema:
            type: string
            example: "9178,5344"
        - name: unit_id
          in: query
          description: Filter by unit radio ID (comma-separated for multiple)
          schema:
            type: string
            example: "924003,104"
        - name: status
          in: query
          description: Filter by status (`affiliated` or `off`)
          schema:
            type: string
            enum: [affiliated, "off"]
        - name: stale_threshold
          in: query
          description: |
            Exclude entries whose last event is older than this many seconds.
          schema:
            type: integer
        - name: active_within
          in: query
          description: |
            Only include entries active within this many seconds.
          schema:
            type: integer
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AffiliationListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Calls
  # ----------------------------------------------------------
  /calls:
    get:
      operationId: listCalls
      summary: List calls
      description: |
        Returns call recordings with comprehensive filters. This is the
        primary endpoint for querying call history.

        **Common patterns:**
        - Live feed: `?sort=-stop_time&deduplicate=true&limit=50`
        - Talkgroup history: `?tgid=9178&sysid=348&start_time=...&end_time=...`
        - Unit activity: `?unit_id=924003`
        - Emergency calls: `?emergency=true&sort=-start_time`
      tags: [calls]
      parameters:
        - name: sysid
          in: query
          description: Filter by P25 SYSID (comma-separated for multiple, e.g., "348,34D")
          schema:
            type: string
        - name: system_id
          in: query
          description: Filter by system database ID (comma-separated for multiple)
          schema:
            type: string
            example: "1,2"
        - name: site_id
          in: query
          description: Filter by recording site ID (comma-separated for multiple)
          schema:
            type: string
            example: "1,3"
        - name: tgid
          in: query
          description: Filter by talkgroup ID (comma-separated for multiple)
          schema:
            type: string
            example: "9178,5344"
        - name: unit_id
          in: query
          description: Filter by unit radio ID (comma-separated for multiple)
          schema:
            type: string
            example: "924003,104"
        - name: emergency
          in: query
          description: Filter by emergency flag
          schema:
            type: boolean
        - name: encrypted
          in: query
          description: Filter by encryption status
          schema:
            type: boolean
        - name: deduplicate
          in: query
          description: |
            When true, returns one call per call_group (best recording).
            Useful for feed views where simulcast duplicates are unwanted.
          schema:
            type: boolean
            default: false
        - $ref: "#/components/parameters/startTime"
        - $ref: "#/components/parameters/endTime"
        - name: sort
          in: query
          description: |
            Sort field. Prefix with `-` for descending.
            Allowed: start_time, stop_time, duration, tgid, freq
          schema:
            type: string
            default: "-start_time"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CallListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /calls/active:
    get:
      operationId: listActiveCalls
      summary: List active calls (real-time)
      description: |
        Returns currently active calls from the in-memory MQTT tracker.
        This is the real-time data source — use it for live dashboards.

        Active calls may have incomplete fields (no stop_time, no audio_url,
        duration is elapsed-so-far). The response uses the same Call schema
        with nullable fields where data is not yet available.
      tags: [calls]
      parameters:
        - name: sysid
          in: query
          description: Filter by P25 SYSID
          schema:
            type: string
        - name: tgid
          in: query
          description: Filter by talkgroup ID
          schema:
            type: integer
        - name: emergency
          in: query
          description: Filter by emergency flag
          schema:
            type: boolean
        - name: encrypted
          in: query
          description: Filter by encryption status
          schema:
            type: boolean
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActiveCallListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /calls/{id}:
    get:
      operationId: getCall
      summary: Get a call
      description: |
        Returns a single call recording by its database ID.
      tags: [calls]
      parameters:
        - $ref: "#/components/parameters/callId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Call"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /calls/{id}/audio:
    get:
      operationId: getCallAudio
      summary: Stream call audio
      description: Streams the audio file for a call. Content-Type varies by source format.
      tags: [calls]
      parameters:
        - $ref: "#/components/parameters/callId"
      responses:
        "200":
          description: Audio stream
          content:
            audio/mp4:
              schema:
                type: string
                format: binary
            audio/mpeg:
              schema:
                type: string
                format: binary
            audio/wav:
              schema:
                type: string
                format: binary
            audio/ogg:
              schema:
                type: string
                format: binary
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /calls/{id}/frequencies:
    get:
      operationId: getCallFrequencies
      summary: Get call frequency list
      description: |
        Returns the frequency entries (freqList) within a call, ordered by
        position in the audio.
      tags: [calls]
      parameters:
        - $ref: "#/components/parameters/callId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CallFrequencyListResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /calls/{id}/transmissions:
    get:
      operationId: getCallTransmissions
      summary: Get call transmission list
      description: |
        Returns the unit transmissions (srcList) within a call, ordered by
        position in the audio. Each entry represents a unit keying up.
        Includes unit alpha_tags.
      tags: [calls]
      parameters:
        - $ref: "#/components/parameters/callId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CallTransmissionListResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Transcriptions
  # ----------------------------------------------------------
  /calls/{id}/transcription:
    get:
      operationId: getCallTranscription
      summary: Get primary transcription for a call
      description: Returns the current primary transcription with unit-attributed word timestamps and segments.
      tags: [transcriptions]
      parameters:
        - $ref: "#/components/parameters/callId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Transcription"
        "404":
          $ref: "#/components/responses/NotFound"

    put:
      operationId: submitTranscriptionCorrection
      summary: Submit transcription
      description: |
        Creates a new primary transcription variant for a call. Defaults to
        source "human" for backward compatibility, but callers can supply
        source, provider, language, and pre-built word/segment data for
        source-side or programmatic transcriptions.
      tags: [transcriptions]
      parameters:
        - $ref: "#/components/parameters/callId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [text]
              properties:
                text:
                  type: string
                  description: Transcription text
                source:
                  type: string
                  description: Transcription source. Defaults to "human" if omitted.
                  example: human
                provider:
                  type: string
                  description: Provider identifier (e.g., "client-whisper", "elevenlabs")
                  example: client-whisper
                language:
                  type: string
                  description: Language code
                  example: en
                words:
                  type: object
                  nullable: true
                  description: |
                    Optional pre-built word/segment data. Same structure as the
                    `words` field in the Transcription schema.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  call_id:
                    type: integer
                  source:
                    type: string
                    example: human
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"

  /calls/{id}/transcriptions:
    get:
      operationId: listCallTranscriptions
      summary: List all transcription variants for a call
      description: |
        Returns all transcription variants (auto, human, LLM) for a call.
        The primary variant is marked with `is_primary: true`.
      tags: [transcriptions]
      parameters:
        - $ref: "#/components/parameters/callId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  transcriptions:
                    type: array
                    items:
                      $ref: "#/components/schemas/Transcription"
                  total:
                    type: integer
        "404":
          $ref: "#/components/responses/NotFound"

  /calls/{id}/transcribe:
    post:
      operationId: transcribeCall
      summary: Queue call for transcription
      description: Queues a call for transcription (or re-transcription). Returns 202 if accepted.
      tags: [transcriptions]
      parameters:
        - $ref: "#/components/parameters/callId"
      responses:
        "202":
          description: Accepted — queued for transcription
          content:
            application/json:
              schema:
                type: object
                properties:
                  call_id:
                    type: integer
                  status:
                    type: string
                    enum: [queued]
        "404":
          $ref: "#/components/responses/NotFound"
        "503":
          description: Transcription queue full or not configured
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /calls/{id}/transcription/verify:
    post:
      operationId: verifyTranscription
      summary: Verify a transcription
      description: Marks the call's current transcription as human-verified.
      tags: [transcriptions]
      parameters:
        - $ref: "#/components/parameters/callId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusChangeResponse"
        "404":
          $ref: "#/components/responses/NotFound"

  /calls/{id}/transcription/reject:
    post:
      operationId: rejectTranscription
      summary: Reject a transcription
      description: Resets the call's transcription_status to "reviewed" (unverified).
      tags: [transcriptions]
      parameters:
        - $ref: "#/components/parameters/callId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusChangeResponse"
        "404":
          $ref: "#/components/responses/NotFound"

  /calls/{id}/transcription/exclude:
    post:
      operationId: excludeFromDataset
      summary: Exclude call from training dataset
      description: Marks a call as permanently excluded from the training dataset.
      tags: [transcriptions]
      parameters:
        - $ref: "#/components/parameters/callId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusChangeResponse"
        "404":
          $ref: "#/components/responses/NotFound"

  /transcriptions/search:
    get:
      operationId: searchTranscriptions
      summary: Full-text search across transcriptions
      description: |
        Searches transcription text using PostgreSQL full-text search.
        Results include call context (talkgroup, system, timing) so no
        follow-up lookups are needed.
      tags: [transcriptions]
      parameters:
        - name: q
          in: query
          required: true
          description: Search query
          schema:
            type: string
        - name: system_id
          in: query
          description: Filter by system ID(s), comma-separated
          schema:
            type: string
        - name: tgid
          in: query
          description: Filter by talkgroup ID(s), comma-separated
          schema:
            type: string
        - name: start_time
          in: query
          description: Start of time range (RFC 3339)
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          description: End of time range (RFC 3339)
          schema:
            type: string
            format: date-time
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TranscriptionSearchResponse"
        "400":
          $ref: "#/components/responses/BadRequest"

  /transcriptions/queue:
    get:
      operationId: getTranscriptionQueueStatus
      summary: Get transcription queue status
      description: Returns statistics about the transcription processing queue.
      tags: [transcriptions]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TranscriptionQueueStats"
        "400":
          $ref: "#/components/responses/BadRequest"

  # ----------------------------------------------------------
  # Call Groups
  # ----------------------------------------------------------
  /call-groups:
    get:
      operationId: listCallGroups
      summary: List call groups
      description: |
        Returns deduplicated call groups (calls from multiple recorders
        grouped together). Each group represents one logical transmission
        captured by one or more recording sites.
      tags: [call-groups]
      parameters:
        - name: sysid
          in: query
          description: Filter by P25 SYSID (comma-separated for multiple)
          schema:
            type: string
        - name: tgid
          in: query
          description: Filter by talkgroup ID (comma-separated for multiple)
          schema:
            type: string
            example: "9178,5344"
        - $ref: "#/components/parameters/startTime"
        - $ref: "#/components/parameters/endTime"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CallGroupListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /call-groups/{id}:
    get:
      operationId: getCallGroup
      summary: Get a call group
      description: Returns a call group with all its individual call recordings.
      tags: [call-groups]
      parameters:
        - name: id
          in: path
          required: true
          description: Call group ID
          schema:
            type: integer
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CallGroupDetailResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Stats
  # ----------------------------------------------------------
  /stats:
    get:
      operationId: getStats
      summary: Get system statistics
      description: |
        Returns overall system statistics including entity counts, call
        metrics, and per-system activity summaries.
      tags: [stats]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /stats/rates:
    get:
      operationId: getDecodeRates
      summary: Get decode rates
      description: Returns system decode rate measurements over time.
      tags: [stats]
      parameters:
        - $ref: "#/components/parameters/startTime"
        - $ref: "#/components/parameters/endTime"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DecodeRatesResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Recorders
  # ----------------------------------------------------------
  /recorders:
    get:
      operationId: listRecorders
      summary: List recorder states
      description: |
        Returns all known recorder states from in-memory cache (populated
        by MQTT recorder messages). Includes embedded system and talkgroup
        display names.
      tags: [recorders]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecorderListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Trunking Messages
  # ----------------------------------------------------------
  /trunking-messages:
    get:
      operationId: listTrunkingMessages
      summary: List trunking messages
      description: |
        Returns P25 control channel trunking messages. These are high-volume;
        use time range filters and pagination. Defaults to the last hour if
        no start_time is provided.
      tags: [stats]
      parameters:
        - name: system_id
          in: query
          description: Filter by system ID (comma-separated for multiple)
          schema:
            type: string
            example: "1,2"
        - name: opcode
          in: query
          description: Filter by opcode hex value (e.g., "2c")
          schema:
            type: string
        - name: opcode_type
          in: query
          description: Filter by opcode type name (e.g., "GRP_V_CH_GRANT")
          schema:
            type: string
        - $ref: "#/components/parameters/startTime"
        - $ref: "#/components/parameters/endTime"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TrunkingMessageListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Console Messages
  # ----------------------------------------------------------
  /console-messages:
    get:
      operationId: listConsoleMessages
      summary: List console messages
      description: |
        Returns trunk-recorder console log messages. Defaults to the last
        hour if no start_time is provided.
      tags: [stats]
      parameters:
        - name: instance_id
          in: query
          description: Filter by trunk-recorder instance ID
          schema:
            type: string
        - name: severity
          in: query
          description: Filter by log severity (e.g., "info", "error")
          schema:
            type: string
        - $ref: "#/components/parameters/startTime"
        - $ref: "#/components/parameters/endTime"
        - $ref: "#/components/parameters/limit"
        - $ref: "#/components/parameters/offset"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConsoleMessageListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # ----------------------------------------------------------
  # Events (SSE)
  # ----------------------------------------------------------
  /events/stream:
    get:
      operationId: streamEvents
      summary: Real-time event stream (SSE)
      description: |
        Opens a Server-Sent Events (SSE) connection that pushes real-time
        events as they are ingested from MQTT. The server filters events
        based on the query parameters — only matching events are sent.

        > **Note:** This is a streaming endpoint. Swagger UI's "Try it out"
        > will hang indefinitely waiting for the response to complete.
        > Use the [Live Events](/events.html) page or connect with
        > `curl` / `EventSource` instead.

        **Connection behavior:**
        - Response uses `Content-Type: text/event-stream`
        - The server sends `X-Accel-Buffering: no` for nginx compatibility
        - A keepalive comment (`: keepalive`) is sent every 15 seconds
        - Each event includes a unique `id` field for gap recovery
        - On reconnect, pass the last received ID via the `Last-Event-ID`
          header to resume without missing events (buffered for 60 seconds)

        **Event format:**
        ```
        id: 1707912345000-42
        event: call_start
        data: {"call_id": 48531, "system_id": 1, "tgid": 9178, ...}
        ```

        **Filtering:**
        All filter parameters are optional. With no filters, all events for
        all systems are streamed. Filters are AND-ed: specifying both
        `systems` and `tgids` means "events matching these systems AND
        these talkgroups." To change filters, disconnect and reconnect
        with new parameters — SSE `Last-Event-ID` provides gapless recovery.

        **Event types:**

        | Event | Description | Payload |
        |-------|-------------|---------|
        | `call_start` | New call recording started | Call object (partial — no audio/transcription yet) |
        | `call_update` | Call updated (new transmission, freq change) | Call object (partial delta) |
        | `call_end` | Call recording completed | Full Call object with audio_url |
        | `unit_event` | Unit lifecycle event | UnitEvent object |
        | `recorder_update` | Recorder state changed | Recorder object |
        | `rate_update` | Decode rate update | DecodeRate object |
        | `trunking_message` | P25 control channel message | TrunkingMessage object |
        | `console` | TR console log message | ConsoleMessage object |

      tags: [events]
      parameters:
        - name: systems
          in: query
          description: |
            Comma-separated system IDs to subscribe to. Omit for all systems.
          schema:
            type: string
            example: "1,2"
        - name: sites
          in: query
          description: |
            Comma-separated site IDs. Omit for all sites within the
            selected systems.
          schema:
            type: string
            example: "1,3"
        - name: tgids
          in: query
          description: |
            Comma-separated talkgroup IDs to filter on. These are plain
            `tgid` values scoped to the selected systems. Omit for all
            talkgroups.
          schema:
            type: string
            example: "9178,5344"
        - name: units
          in: query
          description: |
            Comma-separated unit radio IDs (RIDs) to filter on. Omit for
            all units.
          schema:
            type: string
            example: "924003,104"
        - name: types
          in: query
          description: |
            Comma-separated event types to subscribe to. Omit for all
            event types. Valid values: `call_start`, `call_update`,
            `call_end`, `unit_event`, `recorder_update`, `rate_update`,
            `trunking_message`, `console`.

            Supports compound syntax with `:` to filter on event
            subtypes. For example, `unit_event:call` matches only unit
            call events, while plain `unit_event` matches all unit event
            subtypes (on, off, call, end, join, location, ackresp, data).
            Compound and plain values can be mixed:
            `unit_event:call,unit_event:end,call_start`.
          schema:
            type: string
            example: "call_start,call_end,unit_event:call"
        - name: emergency_only
          in: query
          description: |
            If true, only push events with the emergency flag set.
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: SSE event stream opened
          headers:
            Content-Type:
              schema:
                type: string
                example: text/event-stream
            Cache-Control:
              schema:
                type: string
                example: no-cache
            X-Accel-Buffering:
              schema:
                type: string
                example: "no"
          content:
            text/event-stream:
              schema:
                $ref: "#/components/schemas/SSEEvent"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Pages (Web UI metadata)
  # ----------------------------------------------------------
  /pages:
    get:
      operationId: listPages
      summary: List web UI pages
      description: |
        Scans the web directory for HTML pages with `card-title` meta tags
        and returns metadata for building navigation. Pages without
        `card-title` are excluded.
      tags: [health]
      security: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    path:
                      type: string
                      description: Relative path to the HTML page
                      example: /events.html
                    title:
                      type: string
                      description: Page title from card-title meta tag
                      example: Live Events
                    description:
                      type: string
                      description: Page description from card-description meta tag
                      example: Real-time event stream
                    order:
                      type: integer
                      description: Sort order (lower = first)
                      example: 2
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  # ----------------------------------------------------------
  # Admin
  # ----------------------------------------------------------
  /query:
    post:
      operationId: executeQuery
      summary: Execute a read-only SQL query
      description: |
        Executes an ad-hoc read-only SQL query against the database and
        returns the results. Useful for analytical queries that don't map
        to predefined endpoints.

        **Safety measures:**
        - Query runs inside a `READ ONLY` transaction — INSERT, UPDATE,
          DELETE, DROP, and all other write operations are rejected by
          PostgreSQL.
        - A 30-second statement timeout prevents runaway queries.
        - Results are capped at `limit` rows (default 1000, max 10000).
        - Semicolons are rejected to prevent multi-statement injection.

        Use `$1`, `$2`, etc. as parameter placeholders with the `params`
        array for safe value interpolation.
      tags: [admin]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QueryRequest"
            examples:
              simple:
                summary: Count all units
                value:
                  sql: "SELECT count(*) FROM units"
              parameterized:
                summary: Units on a specific talkgroup
                value:
                  sql: "SELECT DISTINCT ct.src AS unit_id FROM call_transmissions ct JOIN calls c ON c.call_id = ct.call_id AND c.start_time = ct.call_start_time WHERE c.tgid = $1"
                  params: [9178]
                  limit: 500
      responses:
        "200":
          description: Query results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QueryResponse"
        "400":
          description: Invalid query (parse error, write attempt, timeout, etc.)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/systems/merge:
    post:
      operationId: mergeSystems
      summary: Merge two systems
      description: |
        Merges all data from `source_id` into `target_id`, then deletes
        the source system. Use this to fix fragmentation caused by
        instance_id or sys_name changes, or to consolidate an unknown
        system after identification.

        **What happens:**
        - All calls under source are repointed to target system_id
          (call_ids are database PKs and do not change)
        - Talkgroups: source talkgroups are merged into target. If both
          have the same tgid, target metadata is kept and call counts are
          combined. Source-only talkgroups are moved to target.
        - Units: same merge logic as talkgroups
        - Unit events: repointed to target system_id
        - Call groups may be consolidated (recordings that now share
          system_id + tgid + start_time get grouped)
        - Source system is deleted

        **Implications:**
        - Call IDs (database PKs) are stable — bookmarks don't break
        - Talkgroup and unit composite IDs change (old system_id prefix
          becomes invalid, new system_id prefix is correct)
        - This operation is **not reversible**

        After merging, update the trunk-recorder config so future MQTT
        messages use the target system's `(instance_id, short_name)`.
      tags: [admin]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SystemMergeRequest"
      responses:
        "200":
          description: Merge completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SystemMergeResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Source or target system not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Merge would cause data conflicts that cannot be auto-resolved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          $ref: "#/components/responses/InternalError"

# ============================================================
# COMPONENTS
# ============================================================
components:

  # ----------------------------------------------------------
  # Security Schemes
  # ----------------------------------------------------------
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: |
        Bearer token authentication. Pass token in the Authorization header:
        `Authorization: Bearer <token>`

  # ----------------------------------------------------------
  # Reusable Parameters
  # ----------------------------------------------------------
  parameters:
    callId:
      name: id
      in: path
      required: true
      description: Call record database ID
      schema:
        type: integer
        example: 48531

    talkgroupId:
      name: id
      in: path
      required: true
      description: "Talkgroup ID: `system_id:tgid` (e.g., `1:9178`) or plain `tgid`"
      schema:
        type: string
        example: "1:9178"

    unitId:
      name: id
      in: path
      required: true
      description: "Unit ID: `system_id:unit_id` (e.g., `1:924003`) or plain `unit_id`"
      schema:
        type: string
        example: "1:924003"

    startTime:
      name: start_time
      in: query
      description: Start of time range (RFC 3339)
      schema:
        type: string
        format: date-time

    endTime:
      name: end_time
      in: query
      description: End of time range (RFC 3339)
      schema:
        type: string
        format: date-time

    limit:
      name: limit
      in: query
      description: Results per page
      schema:
        type: integer
        default: 50
        minimum: 1
        maximum: 1000

    offset:
      name: offset
      in: query
      description: Page offset (number of results to skip)
      schema:
        type: integer
        default: 0
        minimum: 0

    sort:
      name: sort
      in: query
      description: "Sort field. Prefix with `-` for descending (e.g., `-last_seen`)"
      schema:
        type: string
        default: "alpha_tag"

    sortDir:
      name: sort_dir
      in: query
      description: Sort direction (ignored if sort field uses `-` prefix)
      schema:
        type: string
        enum: [asc, desc]
        default: asc

  # ----------------------------------------------------------
  # Reusable Responses
  # ----------------------------------------------------------
  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    NotFound:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    Ambiguous:
      description: |
        Ambiguous ID — the plain ID exists in multiple systems.
        Response includes the list of matching systems to help the
        client disambiguate.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/AmbiguousError"

    Unauthorized:
      description: Unauthorized — missing or invalid auth token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    InternalError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

  # ----------------------------------------------------------
  # Schemas
  # ----------------------------------------------------------
  schemas:

    # ========== Enums ==========

    SystemType:
      type: string
      enum: [p25, smartnet, conventional]
      description: Radio system protocol type

    TalkgroupMode:
      type: string
      enum: [D, A, E, M, T]
      description: |
        Talkgroup mode: D=Digital, A=Analog, E=Encrypted,
        M=Mixed (digital+analog), T=TDMA

    EventType:
      type: string
      enum: [on, off, join, call, end, data, ans_req, location, ackresp]
      description: |
        Unit event types from trunk-recorder MQTT:
        - **on**: unit registration (radio powered on / entering system)
        - **off**: unit deregistration (radio powered off / leaving system)
        - **join**: talkgroup affiliation (unit joins a talkgroup)
        - **call**: channel grant (voice call participation)
        - **end**: transmission end (per-unit end-of-transmission report)
        - **data**: data grant
        - **ans_req**: answer request
        - **location**: unit location update
        - **ackresp**: acknowledge response

    CallState:
      type: string
      enum: [monitoring, recording, stopped, completed]
      description: |
        Call recording state (mapped from trunk-recorder integer values):
        - **monitoring**: control channel activity seen, no audio capture yet
        - **recording**: actively capturing audio
        - **stopped**: recording ended, finalizing
        - **completed**: audio file written, ready for access

    MonState:
      type: string
      enum: [unspecified, active, duplicate]
      description: |
        Call monitor state (from trunk-recorder):
        - **unspecified**: default / not specifically monitored
        - **active**: actively monitored
        - **duplicate**: duplicate call on another recorder

    RecState:
      type: string
      enum: [available, recording, idle, stopped]
      description: |
        Recorder hardware state:
        - **available**: ready to record
        - **recording**: actively recording a call
        - **idle**: inactive / not assigned
        - **stopped**: finished recording, finalizing

    # ========== Error Models ==========

    Error:
      type: object
      required: [error]
      properties:
        error:
          type: string
          example: Resource not found
        detail:
          type: string
          description: Additional context when available

    AmbiguousError:
      type: object
      required: [error, matches]
      properties:
        error:
          type: string
          example: "Ambiguous ID 9178: exists in multiple systems"
        matches:
          type: array
          description: |
            Systems where this ID was found. Includes system_id so the
            client can construct the composite ID to disambiguate.
          items:
            type: object
            properties:
              system_id:
                type: integer
                description: Database system ID — use this to form the composite ID
                example: 1
              system_name:
                type: string
                description: System display name
                example: "Butler/Warren P25"
              sysid:
                type: string
                description: P25 SYSID (for display context)
                example: "348"

    # ========== Core Domain Models ==========

    System:
      type: object
      description: |
        A logical radio network. For P25, identified by (sysid, wacn).
        For conventional, identified by (instance_id, sys_name).
        Talkgroups and units belong to the system level.
      required: [system_id, system_type]
      properties:
        system_id:
          type: integer
          description: Database primary key — use this in API path parameters and composite IDs
          example: 1
        system_type:
          $ref: "#/components/schemas/SystemType"
        name:
          type: string
          description: |
            User-configurable display name for this system.
            Auto-populated from the first site's short_name, but can be
            overridden (e.g., "Butler/Warren P25 Network").
          example: "Butler/Warren P25"

        # P25 network identity (null/zero for conventional)
        sysid:
          type: string
          description: P25 System ID (hex). "0" for conventional.
          example: "348"
        wacn:
          type: string
          description: P25 WACN. "0" for conventional.
          example: "BEE00"
        # Sites monitoring this system
        sites:
          type: array
          description: Recording sites contributing to this system
          items:
            $ref: "#/components/schemas/Site"

    Site:
      type: object
      description: |
        A recording site — one trunk-recorder sys_name entry monitoring
        a system. Multiple sites may monitor the same P25 network from
        different locations (different NAC/RFSS/site). For conventional
        systems, there is exactly one site per system.
      required: [site_id, short_name]
      properties:
        site_id:
          type: integer
          description: Database primary key for this recording site
          example: 1
        system_id:
          type: integer
          description: Parent system this site belongs to
          example: 1
        short_name:
          type: string
          description: Trunk-recorder sys_name (e.g., "butco", "warco")
          example: butco
        instance_id:
          type: string
          description: Trunk-recorder instance that owns this site
          example: trunk-recorder
        # P25 site-specific identity
        nac:
          type: string
          description: P25 NAC (unique per physical site)
          example: "340"
        rfss:
          type: integer
          description: P25 RFSS
          example: 4
        p25_site_id:
          type: integer
          description: P25 site ID within the RFSS
          example: 1
        # TR config metadata
        sys_num:
          type: integer
          description: |
            Positional index in TR config. Stored for reference only —
            never used for identity (shifts when config is reordered).
          example: 0

    P25System:
      type: object
      description: |
        A logical P25 network with all its recording sites. This is
        the same as a System with system_type=p25, presented with
        sites expanded for the grouped network view.
      properties:
        system_id:
          type: integer
          description: Database system ID
          example: 1
        name:
          type: string
          description: User-configurable display name for this system
          example: "Butler/Warren P25"
        sysid:
          type: string
          example: "348"
        wacn:
          type: string
          example: "BEE00"
        sites:
          type: array
          description: Recording sites monitoring this P25 network
          items:
            $ref: "#/components/schemas/Site"
        talkgroup_count:
          type: integer
          example: 150
        unit_count:
          type: integer
          example: 500
        calls_24h:
          type: integer
          example: 5000

    Talkgroup:
      type: object
      description: A talkgroup on a radio system
      required: [system_id, tgid]
      properties:
        system_id:
          type: integer
          description: Database system ID this talkgroup belongs to
          example: 1
        system_name:
          type: string
          description: System display name (embedded to avoid lookup)
          example: "Butler/Warren P25"
        sysid:
          type: string
          description: P25 SYSID (for display; "0" for conventional)
          example: "348"
        tgid:
          type: integer
          example: 1001
        alpha_tag:
          type: string
          example: Fire Dispatch
        tag:
          type: string
          description: Radio Reference tag category
          example: Fire Dispatch
        group:
          type: string
          description: Grouping category for UI filtering
          example: Fire
        description:
          type: string
          example: County Fire Dispatch Channel
        mode:
          $ref: "#/components/schemas/TalkgroupMode"
        priority:
          type: integer
          description: Display priority (lower = more important)
          example: 1
        first_seen:
          type: string
          format: date-time
        last_seen:
          type: string
          format: date-time
        # Stats (populated by list/detail queries)
        call_count:
          type: integer
          description: Total calls recorded on this talkgroup
          example: 1547
        calls_1h:
          type: integer
          description: Calls in the last hour
          example: 12
        calls_24h:
          type: integer
          description: Calls in the last 24 hours
          example: 234
        unit_count:
          type: integer
          description: Distinct units seen on this talkgroup
          example: 45
        # Search field (only present when search param is used)
        relevance_score:
          type: integer
          description: "Search relevance: 100=exact, 50=prefix, 10=contains. Only present in search results."
          example: 100

    Unit:
      type: object
      description: A radio unit (mobile or portable radio)
      required: [system_id, unit_id]
      properties:
        system_id:
          type: integer
          description: Database system ID this unit belongs to
          example: 1
        system_name:
          type: string
          description: System display name (embedded to avoid lookup)
          example: "Butler/Warren P25"
        sysid:
          type: string
          description: P25 SYSID (for display; "0" for conventional)
          example: "348"
        unit_id:
          type: integer
          example: 1234567
        alpha_tag:
          type: string
          example: Engine 1
        alpha_tag_source:
          type: string
          description: Source of the alpha tag (e.g., radioreference, manual)
          example: radioreference
        first_seen:
          type: string
          format: date-time
        last_seen:
          type: string
          format: date-time
        # Last event context (embedded)
        last_event_type:
          $ref: "#/components/schemas/EventType"
        last_event_time:
          type: string
          format: date-time
        last_event_tgid:
          type: integer
          example: 9178
        last_event_tg_tag:
          type: string
          description: Alpha tag of the talkgroup from last event
          example: "09-8L Main"
        # Search field
        relevance_score:
          type: integer
          description: "Search relevance: 100=exact, 50=prefix, 10=contains. Only present in search results."
          example: 100

    Call:
      type: object
      description: A recorded radio call/transmission
      required: [call_id, system_id, tgid, start_time]
      properties:
        # Identifiers
        call_id:
          type: integer
          description: Unique database ID for this recording
          example: 48531
        call_group_id:
          type: integer
          description: |
            Call group this recording belongs to. Multiple recordings of the
            same transmission (from different sites) share a call_group_id.
            Derived from (system_id, tgid, start_unix).
          example: 1

        # System context (embedded to avoid lookup)
        system_id:
          type: integer
          description: Logical radio system this call belongs to
          example: 1
        system_name:
          type: string
          description: System display name
          example: "Butler/Warren P25"
        sysid:
          type: string
          description: P25 SYSID (for display; "0" for conventional)
          example: "348"

        # Site context (which recorder captured this)
        site_id:
          type: integer
          description: Recording site that captured this call
          example: 1
        site_short_name:
          type: string
          description: TR sys_name of the capturing site (e.g., "butco", "warco")
          example: butco

        # Talkgroup context (embedded to avoid lookup)
        tgid:
          type: integer
          example: 9178
        tg_alpha_tag:
          type: string
          description: Talkgroup short-form display name
          example: "09-8L Main"
        tg_description:
          type: string
          description: Human-readable talkgroup description
          example: Middletown Police Dispatch
        tg_tag:
          type: string
          description: Functional category tag (e.g., Law Dispatch, Fire Tac)
          example: Law Dispatch
        tg_group:
          type: string
          description: Broad organizational grouping
          example: "Butler County (09) Law"

        # Timing
        start_time:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        stop_time:
          type: string
          format: date-time
          nullable: true
          description: "Null for active (in-progress) calls"
          example: "2024-01-15T10:30:45Z"
        duration:
          type: number
          description: Duration in seconds (elapsed so far for active calls)
          example: 45.5

        # Audio
        audio_url:
          type: string
          nullable: true
          description: "Relative URL to audio endpoint. Null for active calls."
          example: /api/v1/calls/48531/audio
        audio_type:
          type: string
          description: "Audio encoding type from trunk-recorder (e.g., `digital`, `digital tdma`, `analog`)"
          example: digital
        audio_size:
          type: integer
          description: Audio file size in bytes
          example: 45000

        # Signal quality
        freq:
          type: integer
          description: Frequency in Hz
          example: 851012500
        freq_error:
          type: integer
          description: Frequency error in Hz
          example: 0
        signal_db:
          type: number
          nullable: true
          description: Signal strength in dB (null if unavailable; MQTT sends 999 as sentinel)
          example: -23
        noise_db:
          type: number
          nullable: true
          description: Noise floor in dB (null if unavailable; MQTT sends 999 as sentinel)
          example: -50
        error_count:
          type: integer
          description: Decode error count
          example: 2
        spike_count:
          type: integer
          description: Audio spike count
          example: 0

        # Status
        call_state:
          $ref: "#/components/schemas/CallState"
        mon_state:
          $ref: "#/components/schemas/MonState"
        emergency:
          type: boolean
          example: false
        encrypted:
          type: boolean
          example: false
        analog:
          type: boolean
          example: false
        conventional:
          type: boolean
          example: false
        phase2_tdma:
          type: boolean
          example: false
        tdma_slot:
          type: integer
          description: "TDMA slot (0=slot 1 or N/A, 1=slot 2)"
          example: 0

        # Patches
        patched_tgids:
          type: array
          description: Other talkgroup IDs patched into this call
          items:
            type: integer

        # Transmission and frequency data (JSONB columns)
        src_list:
          type: array
          description: |
            Source/transmission list from trunk-recorder's srcList.
            Each entry is a unit transmission segment within the call.
            Also available via GET /calls/{id}/transmissions.
          items:
            $ref: "#/components/schemas/CallTransmission"
        freq_list:
          type: array
          description: |
            Frequency list from trunk-recorder's freqList.
            Each entry is a frequency segment within the call.
            Also available via GET /calls/{id}/frequencies.
          items:
            $ref: "#/components/schemas/CallFrequency"
        unit_ids:
          type: array
          description: Denormalized array of distinct unit radio IDs (src values) from src_list. GIN-indexed for fast unit filtering.
          items:
            type: integer

        # Units on this call (embedded)
        units:
          type: array
          items:
            $ref: "#/components/schemas/CallUnit"

        # Transcription (denormalized from transcriptions table)
        has_transcription:
          type: boolean
          description: Whether this call has been transcribed
          example: true
        transcription_status:
          $ref: "#/components/schemas/TranscriptionStatus"
        transcription_text:
          type: string
          nullable: true
          description: Primary transcription text (null if no transcription)
          example: Engine 5 responding to the scene
        transcription_word_count:
          type: integer
          nullable: true
          example: 6

        # Extensible metadata
        metadata_json:
          type: object
          additionalProperties: true
          description: Arbitrary metadata from trunk-recorder

    CallUnit:
      type: object
      description: A unit that transmitted during a call
      required: [system_id, unit_id]
      properties:
        system_id:
          type: integer
          description: Database system ID for disambiguation in multi-system deployments
          example: 1
        unit_id:
          type: integer
          description: Unit radio ID (RID)
          example: 924003
        alpha_tag:
          type: string
          description: Unit display name
          example: "09 7COM3"

    UnitEvent:
      type: object
      description: A unit event (registration, affiliation, call activity, etc.)
      required: [id, event_type, unit_rid, time]
      properties:
        id:
          type: integer
          example: 1
        event_type:
          $ref: "#/components/schemas/EventType"
        time:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

        # System context
        system_id:
          type: integer
          description: Database system ID
          example: 1
        system_name:
          type: string
          description: System display name
          example: "Butler/Warren P25"

        # Unit context (embedded to avoid lookup)
        unit_rid:
          type: integer
          example: 1234567
        unit_alpha_tag:
          type: string
          description: Unit display name (embedded to avoid lookup)
          example: Engine 1

        # Talkgroup context (embedded to avoid lookup)
        tgid:
          type: integer
          example: 1001
        tg_alpha_tag:
          type: string
          description: Talkgroup short-form display name
          example: "09-8L Main"
        tg_description:
          type: string
          description: Human-readable talkgroup description
          example: Middletown Police Dispatch

        # Internal references
        instance_id:
          type: string
          description: Trunk-recorder instance that reported this event
          example: trunk-recorder
        metadata_json:
          type: object
          additionalProperties: true

    CallFrequency:
      type: object
      description: |
        A frequency segment from trunk-recorder's freqList. Each entry
        represents a period of time the call spent on a given frequency.
      properties:
        freq:
          type: integer
          description: Frequency in Hz
          example: 154875000
        time:
          type: integer
          description: Unix timestamp of when this frequency segment started
          example: 1713207802
        pos:
          type: number
          description: Position in the audio file in seconds
          example: 0.0
        len:
          type: number
          description: Duration on this frequency in seconds
          example: 3.24
        error_count:
          type: integer
          example: 50
        spike_count:
          type: integer
          example: 3

    CallTransmission:
      type: object
      description: |
        A unit key-up from trunk-recorder's srcList. Each entry represents
        one unit's transmission within the call. The `src` field maps to
        the unit radio ID (RID).
      properties:
        src:
          type: integer
          description: Unit radio ID (RID) — matches unit_id in other models
          example: 104
        tag:
          type: string
          description: Unit alpha tag at time of transmission (from trunk-recorder)
          example: "09 7COM3"
        time:
          type: integer
          description: Unix timestamp of when this unit keyed up
          example: 1713207802
        pos:
          type: number
          description: Position in audio file in seconds
          example: 0.0
        duration:
          type: number
          description: Duration of this transmission segment in seconds (computed from gap to next transmission or end of call)
          example: 3.5
        emergency:
          type: integer
          description: "Emergency flag (0=normal, 1=emergency)"
          example: 0
        signal_system:
          type: string
          description: Signal system identifier (typically empty)
          example: ""

    CallGroup:
      type: object
      description: |
        A group of duplicate call recordings from multiple recorders.
        Derived from (system_id, tgid, start_unix) — recordings that match
        on all three are grouped.
      properties:
        id:
          type: integer
          example: 1
        # System context (embedded)
        system_id:
          type: integer
          example: 1
        system_name:
          type: string
          description: System display name
          example: "Butler/Warren P25"
        sysid:
          type: string
          description: P25 SYSID (for display)
          example: "348"
        # Site that captured the primary recording
        site_id:
          type: integer
          example: 1
        site_short_name:
          type: string
          example: butco
        # Talkgroup context (embedded)
        tgid:
          type: integer
          example: 9178
        tg_alpha_tag:
          type: string
          description: Talkgroup short-form display name
          example: "09-8L Main"
        tg_description:
          type: string
          description: Human-readable talkgroup description
          example: Middletown Police Dispatch
        tg_tag:
          type: string
          description: Functional category tag
          example: Law Dispatch
        tg_group:
          type: string
          description: Broad organizational grouping
          example: "Butler County (09) Law"
        # Timing
        start_time:
          type: string
          format: date-time
        stop_time:
          type: string
          format: date-time
        duration:
          type: number
          example: 45.5
        # Group info
        call_count:
          type: integer
          description: Number of recordings in this group
          example: 2
        primary_call_id:
          type: integer
          description: Call ID of the best-quality recording
          example: 48531
        # Transcription (denormalized from primary call)
        has_transcription:
          type: boolean
          example: true
        transcription_status:
          $ref: "#/components/schemas/TranscriptionStatus"
        transcription_text:
          type: string
          nullable: true
          example: Engine 5 responding to the scene

    # ========== Transcription schemas ==========

    TranscriptionStatus:
      type: string
      enum: [none, auto, reviewed, verified, excluded]
      description: |
        - **none**: no transcription attempted
        - **auto**: machine-transcribed, unreviewed
        - **reviewed**: passed quality checks
        - **verified**: human-verified correct
        - **excluded**: permanently excluded from dataset

    TranscriptionSource:
      type: string
      enum: [auto, human, llm]
      description: |
        - **auto**: automated transcription (e.g., Whisper)
        - **human**: human correction/transcription
        - **llm**: LLM-generated correction

    Transcription:
      type: object
      description: A transcription of a call's audio content with unit attribution
      required: [id, call_id, text, source]
      properties:
        id:
          type: integer
          example: 1
        call_id:
          type: integer
          example: 48531
        text:
          type: string
          example: Engine 5 responding to the scene
        source:
          $ref: "#/components/schemas/TranscriptionSource"
        is_primary:
          type: boolean
          example: true
        confidence:
          type: number
          nullable: true
          minimum: 0
          maximum: 1
          example: 0.95
        language:
          type: string
          example: en
        model:
          type: string
          example: deepdml/faster-whisper-large-v3-turbo-ct2
        provider:
          type: string
          example: whisper
        word_count:
          type: integer
          example: 6
        duration_ms:
          type: integer
          description: Transcription processing time in milliseconds
          example: 1500
        created_at:
          type: string
          format: date-time
        words:
          type: object
          description: |
            Unit-attributed word timestamps and segments. The `words` array
            contains every word with timing and the radio unit that said it.
            The `segments` array groups consecutive words by the same unit.
          properties:
            words:
              type: array
              items:
                $ref: "#/components/schemas/AttributedWord"
            segments:
              type: array
              items:
                $ref: "#/components/schemas/TranscriptionSegment"

    AttributedWord:
      type: object
      description: A word with timing and unit attribution
      required: [word, start, end, src]
      properties:
        word:
          type: string
          example: Engine
        start:
          type: number
          description: Start time in seconds from audio start
          example: 0.12
        end:
          type: number
          description: End time in seconds from audio start
          example: 0.45
        src:
          type: integer
          description: Unit/radio ID (0 if unattributed)
          example: 9130
        src_tag:
          type: string
          description: Unit alpha tag
          example: "Medic 83"

    TranscriptionSegment:
      type: object
      description: Consecutive words from the same radio unit
      required: [src, start, end, text]
      properties:
        src:
          type: integer
          description: Unit/radio ID
          example: 9130
        src_tag:
          type: string
          example: "Medic 83"
        start:
          type: number
          example: 0.12
        end:
          type: number
          example: 1.8
        text:
          type: string
          example: "Medic 83 transporting to Fort."

    TranscriptionSearchHit:
      type: object
      description: A search result with relevance score and call context
      properties:
        id:
          type: integer
        call_id:
          type: integer
        text:
          type: string
        source:
          type: string
        is_primary:
          type: boolean
        word_count:
          type: integer
        duration_ms:
          type: integer
        created_at:
          type: string
          format: date-time
        rank:
          type: number
          description: Search relevance score (higher is better)
        system_id:
          type: integer
        system_name:
          type: string
        tgid:
          type: integer
        tg_alpha_tag:
          type: string
        call_start_time:
          type: string
          format: date-time
        call_duration:
          type: number
          nullable: true

    TranscriptionSearchResponse:
      type: object
      required: [results, total, limit, offset]
      properties:
        results:
          type: array
          items:
            $ref: "#/components/schemas/TranscriptionSearchHit"
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    TranscriptionQueueStats:
      type: object
      properties:
        status:
          type: string
          enum: [ok, not_configured]
        pending:
          type: integer
          example: 15
        completed:
          type: integer
          example: 5000
        failed:
          type: integer
          example: 12

    StatusChangeResponse:
      type: object
      properties:
        call_id:
          type: integer
          example: 48531
        status:
          type: string
          example: verified

    Recorder:
      type: object
      description: |
        A trunk-recorder recorder (SDR channel). Core fields come directly
        from the MQTT `recorders` message. Activity fields (talkgroup, unit)
        are joined from active calls by the API layer when available.
      properties:
        id:
          type: string
          description: "Composite recorder ID from MQTT: `{src_num}_{rec_num}`"
          example: "4_16"
        src_num:
          type: integer
          description: Source number (which SDR dongle)
          example: 4
        rec_num:
          type: integer
          description: Recorder number within the source
          example: 16
        type:
          type: string
          description: Recorder type from trunk-recorder (P25, P25C, ANALOG, etc.)
          example: "P25"
        rec_state:
          $ref: "#/components/schemas/RecState"
        freq:
          type: integer
          description: Current frequency in Hz (0 when idle)
          example: 852200000
        duration:
          type: number
          description: Current recording duration in seconds
          example: 21182.10
        count:
          type: integer
          description: Number of transmissions recorded
          example: 3563
        squelched:
          type: boolean
          example: false
        # Active call context (joined by API from active calls, nullable when idle)
        tgid:
          type: integer
          nullable: true
          description: Current talkgroup ID (null when idle). Joined from active calls.
          example: 9178
        tg_alpha_tag:
          type: string
          nullable: true
          description: Current talkgroup display name. Joined from active calls.
          example: "09-8L Main"
        unit_id:
          type: integer
          nullable: true
          description: Current transmitting unit ID (null when idle). Joined from active calls.
          example: 924003
        unit_alpha_tag:
          type: string
          nullable: true
          description: Current transmitting unit display name. Joined from active calls.
          example: "09 7COM3"

    # ========== Request Models ==========

    SystemPatch:
      type: object
      description: |
        Mutable system-level fields. Only provided fields are updated.
        For P25, changing sysid/wacn affects the network identity used
        at ingest. For site-level changes (short_name, nac, instance_id),
        use SitePatch on PATCH /sites/{id}.
      properties:
        sysid:
          type: string
          description: P25 System ID (hex)
          example: "348"
        wacn:
          type: string
          description: P25 WACN
          example: "BEE00"
        name:
          type: string
          description: Optional display name for the system (e.g., "Butler/Warren P25")

    SitePatch:
      type: object
      description: |
        Mutable site-level fields. Only provided fields are updated.
        Changing `short_name` or `instance_id` updates the ingest
        lookup key — make sure the trunk-recorder config matches or
        future messages will create a new site (fragmentation).
      properties:
        short_name:
          type: string
          description: |
            Trunk-recorder sys_name. Changing this updates the
            `(instance_id, short_name)` → `site_id` mapping.
          example: butco
        instance_id:
          type: string
          description: Trunk-recorder instance ID this site belongs to
          example: trunk-recorder
        nac:
          type: string
          description: P25 NAC
          example: "340"
        rfss:
          type: integer
          example: 4
        p25_site_id:
          type: integer
          example: 1

    SystemMergeRequest:
      type: object
      required: [source_id, target_id]
      properties:
        source_id:
          type: integer
          description: System to merge FROM (will be deleted after merge)
          example: 3
        target_id:
          type: integer
          description: System to merge INTO (keeps its system_id)
          example: 1
        update_target_metadata:
          type: boolean
          description: |
            If true, copy short_name/sysid/wacn/nac from source to target
            (useful when the source has better metadata, e.g., was identified
            after the target was created as "unknown").
          default: false

    SystemMergeResponse:
      type: object
      properties:
        target_id:
          type: integer
          description: The surviving system_id
          example: 1
        source_id:
          type: integer
          description: The deleted system_id
          example: 3
        calls_moved:
          type: integer
          description: Number of call records repointed
          example: 5200
        talkgroups_moved:
          type: integer
          description: Talkgroups moved from source (source-only)
          example: 12
        talkgroups_merged:
          type: integer
          description: Talkgroups that existed in both (stats combined)
          example: 45
        units_moved:
          type: integer
          example: 30
        units_merged:
          type: integer
          example: 150
        events_moved:
          type: integer
          description: Unit events repointed
          example: 25000

    TalkgroupPatch:
      type: object
      description: Mutable talkgroup fields. Only provided fields are updated.
      properties:
        alpha_tag:
          type: string
        description:
          type: string
        group:
          type: string
        tag:
          type: string
        priority:
          type: integer

    UnitPatch:
      type: object
      description: Mutable unit fields. Only provided fields are updated.
      properties:
        alpha_tag:
          type: string
        alpha_tag_source:
          type: string

    # ========== Response Wrappers ==========

    HealthResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        version:
          type: string
          example: "0.6.1"
        uptime_seconds:
          type: integer
          example: 86400
        checks:
          type: object
          description: Individual subsystem health
          properties:
            database:
              type: string
              enum: [ok, error]
            mqtt:
              type: string
              enum: [ok, error, disconnected]
            transcription:
              type: string
              enum: [ok, not_configured]
        trunk_recorders:
          type: array
          description: Status of connected trunk-recorder instances
          items:
            type: object
            properties:
              instance_id:
                type: string
                example: "trunk-recorder"
              status:
                type: string
                example: "connected"
              last_seen:
                type: string
                format: date-time

    # --- Paginated list responses ---

    SystemListResponse:
      type: object
      required: [systems, total]
      properties:
        systems:
          type: array
          items:
            $ref: "#/components/schemas/System"
        total:
          type: integer
          description: Total number of systems
          example: 3

    P25SystemListResponse:
      type: object
      required: [systems, total]
      properties:
        systems:
          type: array
          items:
            $ref: "#/components/schemas/P25System"
        total:
          type: integer
          description: Total number of P25 networks
          example: 2

    TalkgroupListResponse:
      type: object
      required: [talkgroups, total, limit, offset]
      properties:
        talkgroups:
          type: array
          items:
            $ref: "#/components/schemas/Talkgroup"
        total:
          type: integer
          description: Total matching results (across all pages)
          example: 150
        limit:
          type: integer
          example: 50
        offset:
          type: integer
          example: 0

    UnitListResponse:
      type: object
      required: [units, total, limit, offset]
      properties:
        units:
          type: array
          items:
            $ref: "#/components/schemas/Unit"
        total:
          type: integer
          example: 500
        limit:
          type: integer
          example: 50
        offset:
          type: integer
          example: 0

    UnitEventListResponse:
      type: object
      required: [events, total, limit, offset]
      properties:
        events:
          type: array
          items:
            $ref: "#/components/schemas/UnitEvent"
        total:
          type: integer
          example: 100
        limit:
          type: integer
          example: 50
        offset:
          type: integer
          example: 0

    Affiliation:
      type: object
      required: [system_id, unit_id, tgid, affiliated_since, last_event_time, status]
      properties:
        system_id:
          type: integer
        system_name:
          type: string
        sysid:
          type: string
        unit_id:
          type: integer
        unit_alpha_tag:
          type: string
        tgid:
          type: integer
        tg_alpha_tag:
          type: string
        tg_description:
          type: string
        tg_tag:
          type: string
        tg_group:
          type: string
        previous_tgid:
          type: integer
          nullable: true
          description: Previous talkgroup before this affiliation (null if first seen)
        affiliated_since:
          type: string
          format: date-time
          description: When the current talkgroup affiliation started
        last_event_time:
          type: string
          format: date-time
          description: Most recent event time for this unit
        status:
          type: string
          enum: [affiliated, "off"]
          description: |
            `affiliated` = unit is actively affiliated with the talkgroup.
            `off` = unit sent an off/deregistration event.

    AffiliationListResponse:
      type: object
      required: [affiliations, total, limit, offset, summary]
      properties:
        affiliations:
          type: array
          items:
            $ref: "#/components/schemas/Affiliation"
        total:
          type: integer
          description: Total matching affiliations (before pagination)
        limit:
          type: integer
          example: 50
        offset:
          type: integer
          example: 0
        summary:
          type: object
          properties:
            talkgroup_counts:
              type: object
              additionalProperties:
                type: integer
              description: |
                Map of tgid → count of affiliated (non-off) units on that
                talkgroup. Computed over the full filtered set before pagination.

    CallListResponse:
      type: object
      required: [calls, total, limit, offset]
      properties:
        calls:
          type: array
          items:
            $ref: "#/components/schemas/Call"
        total:
          type: integer
          description: Total matching results (across all pages)
          example: 2500
        limit:
          type: integer
          example: 50
        offset:
          type: integer
          example: 0

    ActiveCallListResponse:
      type: object
      required: [calls, total]
      properties:
        calls:
          type: array
          description: |
            Active calls from MQTT tracker. Fields like stop_time and
            audio_url will be null since the call is still in progress.
          items:
            $ref: "#/components/schemas/Call"
        total:
          type: integer
          description: Number of currently active calls
          example: 5

    CallGroupListResponse:
      type: object
      required: [call_groups, total, limit, offset]
      properties:
        call_groups:
          type: array
          items:
            $ref: "#/components/schemas/CallGroup"
        total:
          type: integer
          example: 500
        limit:
          type: integer
          example: 50
        offset:
          type: integer
          example: 0

    CallGroupDetailResponse:
      type: object
      required: [call_group, calls]
      properties:
        call_group:
          $ref: "#/components/schemas/CallGroup"
        calls:
          type: array
          description: All individual recordings in this group
          items:
            $ref: "#/components/schemas/Call"

    CallFrequencyListResponse:
      type: object
      required: [frequencies, total]
      properties:
        frequencies:
          type: array
          items:
            $ref: "#/components/schemas/CallFrequency"
        total:
          type: integer
          example: 3

    CallTransmissionListResponse:
      type: object
      required: [transmissions, total]
      properties:
        transmissions:
          type: array
          items:
            $ref: "#/components/schemas/CallTransmission"
        total:
          type: integer
          example: 4

    # --- Stats responses ---

    StatsResponse:
      type: object
      properties:
        systems:
          type: integer
          description: Total recording sites
          example: 3
        talkgroups:
          type: integer
          description: Total talkgroups across all systems
          example: 500
        units:
          type: integer
          description: Total units across all systems
          example: 1000
        total_calls:
          type: integer
          description: Total call recordings
          example: 250000
        calls_24h:
          type: integer
          description: Calls recorded in the last 24 hours
          example: 5000
        calls_1h:
          type: integer
          description: Calls recorded in the last hour
          example: 250
        total_duration_hours:
          type: number
          description: Total recorded audio in hours
          example: 4500.5
        system_activity:
          type: array
          description: Per-system activity breakdown
          items:
            $ref: "#/components/schemas/SystemActivity"

    SystemActivity:
      type: object
      properties:
        system_id:
          type: integer
          example: 1
        system_name:
          type: string
          description: System display name
          example: "Butler/Warren P25"
        sysid:
          type: string
          example: "348"
        calls_1h:
          type: integer
          example: 100
        calls_24h:
          type: integer
          example: 2000
        active_talkgroups:
          type: integer
          description: Talkgroups with activity in the last hour
          example: 35
        active_units:
          type: integer
          description: Units with activity in the last hour
          example: 80

    DecodeRatesResponse:
      type: object
      required: [rates, total]
      properties:
        rates:
          type: array
          items:
            $ref: "#/components/schemas/DecodeRate"
        total:
          type: integer
          example: 100

    DecodeRate:
      type: object
      properties:
        time:
          type: string
          format: date-time
        system_id:
          type: integer
          example: 1
        system_name:
          type: string
          description: System display name
          example: "Butler/Warren P25"
        sysid:
          type: string
          example: "348"
        decode_rate:
          type: number
          description: Decode success rate (0.0 - 1.0)
          example: 0.98
        total_messages:
          type: integer
          description: Total messages in this measurement period
          example: 5000

    EncryptionStatsResponse:
      type: object
      required: [stats, total]
      properties:
        stats:
          type: array
          items:
            $ref: "#/components/schemas/TalkgroupEncryptionStat"
        total:
          type: integer
          example: 50
        hours:
          type: integer
          description: Time window used
          example: 24

    TalkgroupEncryptionStat:
      type: object
      properties:
        system_id:
          type: integer
          description: Database system ID
          example: 1
        system_name:
          type: string
          description: System display name (embedded to avoid lookup)
          example: "Butler/Warren P25"
        sysid:
          type: string
          description: P25 SYSID (for display)
          example: "348"
        tgid:
          type: integer
          example: 9178
        tg_alpha_tag:
          type: string
          example: "09-8L Main"
        tg_description:
          type: string
          description: Human-readable talkgroup description
          example: Middletown Police Dispatch
        tg_tag:
          type: string
          description: Functional category tag
          example: Law Dispatch
        tg_group:
          type: string
          description: Broad organizational grouping
          example: "Butler County (09) Law"
        encrypted_count:
          type: integer
          example: 0
        clear_count:
          type: integer
          example: 150
        total_count:
          type: integer
          example: 150
        encrypted_pct:
          type: number
          description: Percentage of calls that were encrypted (0.0 - 100.0)
          example: 0.0

    TalkgroupDirectoryEntry:
      type: object
      properties:
        system_id:
          type: integer
          example: 1
        system_name:
          type: string
          example: "butco"
        tgid:
          type: integer
          example: 5000
        alpha_tag:
          type: string
          example: "FD01DISP"
        mode:
          type: string
          example: "D"
        description:
          type: string
          example: "County Fire/EMS Dispatch"
        tag:
          type: string
          example: "Fire Dispatch"
        category:
          type: string
          example: "Adams County (01)"
        priority:
          type: integer
          nullable: true
          example: 1

    RecorderListResponse:
      type: object
      required: [recorders, total]
      properties:
        recorders:
          type: array
          items:
            $ref: "#/components/schemas/Recorder"
        total:
          type: integer
          example: 12

    # ========== SSE Event Models ==========

    SSEEventType:
      type: string
      enum:
        - call_start
        - call_update
        - call_end
        - unit_event
        - recorder_update
        - rate_update
        - trunking_message
        - console
      description: |
        SSE event types pushed to clients:
        - **call_start**: new call recording began
        - **call_update**: call updated (new transmission, freq change)
        - **call_end**: call recording completed, audio available
        - **unit_event**: unit lifecycle event (on/off/join/call/end/etc.)
        - **recorder_update**: recorder hardware state changed
        - **rate_update**: decode rate update from a system
        - **trunking_message**: P25 control channel message
        - **console**: trunk-recorder console log message

    SSEEvent:
      type: object
      properties:
        event:
          $ref: "#/components/schemas/SSEEventType"
      additionalProperties: true
      description: |
        Each SSE event is sent as three lines:
        ```
        id: 1707912345000-42
        event: call_start
        data: {"call_id": 48531, "system_id": 1, "tgid": 9178, ...}
        ```

        The SSE fields map to the browser's `EventSource` API:
        - `id` → `event.lastEventId` — unique event ID (`{unix_ms}-{seq}`),
          pass as `Last-Event-ID` header on reconnect for gapless recovery
        - `event` → selects the `addEventListener` handler — one of the
          SSEEventType values (call_start, call_end, unit_event, etc.)
        - `data` → `event.data` — the JSON payload described below

        The `data` field contains the **domain object directly**, not a
        wrapper. Its structure depends on the event type:
        - `call_start` / `call_update` / `call_end`: Call object
        - `unit_event`: UnitEvent object
        - `recorder_update`: Recorder object
        - `rate_update`: DecodeRate object
        - `trunking_message`: TrunkingMessage object
        - `console`: ConsoleMessage object

        Server-side filtering metadata (system_id, site_id, tgid, unit_id)
        is used internally to match events against query params but is not
        sent as a separate envelope — these fields are already present in
        the domain objects themselves.

    TrunkingMessage:
      type: object
      description: P25 control channel trunking message
      properties:
        id:
          type: integer
        system_id:
          type: integer
          example: 1
        sys_name:
          type: string
          example: "butco"
        trunk_msg:
          type: integer
          description: Trunk message code
        trunk_msg_type:
          type: string
          description: Trunk message type name
          example: "GRANT"
        opcode:
          type: string
          description: P25 opcode hex value
          example: "2c"
        opcode_type:
          type: string
          description: Human-readable opcode type name
          example: "Unit Registration Response"
        opcode_desc:
          type: string
          description: Detailed description of the opcode
        meta:
          type: object
          additionalProperties: true
          description: Opcode-specific metadata fields
        time:
          type: string
          format: date-time
        instance_id:
          type: string

    TrunkingMessageListResponse:
      type: object
      required: [messages, total]
      properties:
        messages:
          type: array
          items:
            $ref: "#/components/schemas/TrunkingMessage"
        total:
          type: integer
          description: Total matching messages (for pagination)

    ConsoleMessage:
      type: object
      description: Trunk-recorder console log message
      properties:
        id:
          type: integer
        instance_id:
          type: string
          example: trunk-recorder
        severity:
          type: string
          example: info
        log_msg:
          type: string
          example: "[butco] Control Channel: 851012500"
        log_time:
          type: string
          format: date-time

    ConsoleMessageListResponse:
      type: object
      required: [messages, total]
      properties:
        messages:
          type: array
          items:
            $ref: "#/components/schemas/ConsoleMessage"
        total:
          type: integer
          description: Total matching messages (for pagination)

    QueryRequest:
      type: object
      required: [sql]
      properties:
        sql:
          type: string
          description: SQL query to execute. Must be a single statement (no semicolons). Use $1, $2, etc. for parameter placeholders.
          example: "SELECT tgid, alpha_tag FROM talkgroups WHERE system_id = $1"
        params:
          type: array
          items: {}
          description: Parameter values for $1, $2, etc. placeholders in the SQL query.
          example: [1]
        limit:
          type: integer
          minimum: 1
          maximum: 10000
          default: 1000
          description: Maximum number of rows to return.

    QueryResponse:
      type: object
      required: [columns, rows, row_count]
      properties:
        columns:
          type: array
          items:
            type: string
          description: Column names from the query result.
          example: ["tgid", "alpha_tag"]
        rows:
          type: array
          items:
            type: array
            items: {}
          description: Result rows, each an array of values matching the columns order.
          example: [[9178, "09 DISP"], [9112, "09 LAW1"]]
        row_count:
          type: integer
          description: Number of rows returned.
          example: 2
