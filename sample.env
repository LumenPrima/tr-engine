# tr-engine configuration
# Copy this file to .env and fill in your values.
# .env is gitignored and auto-loaded on startup.

# =============================================================================
# Docker Compose only — ignored when running the binary directly
# =============================================================================

# PostgreSQL credentials for the bundled database container.
# These configure both the postgres container and tr-engine's DATABASE_URL
# automatically — no need to set DATABASE_URL separately in Docker mode.
# POSTGRES_USER=trengine
# POSTGRES_PASSWORD=trengine
# POSTGRES_DB=trengine

# Host port mappings (container-internal ports stay fixed)
# HTTP_PORT=8080
# MQTT_PORT=1883
#
# Volume mounts are configured in docker-compose.yml, not here.
# Common optional mounts (uncomment in docker-compose.yml):
#   /path/to/trunk-recorder:/tr-config:ro   — TR auto-discovery (set TR_DIR=/tr-config)
#   /path/to/trunk-recorder/audio:/tr-audio:ro — filesystem audio (set TR_AUDIO_DIR=/tr-audio)
#   ./web:/opt/tr-engine/web                — web UI override (no restart needed)

# =============================================================================
# Required (at least one of MQTT_BROKER_URL, WATCH_DIR, or TR_DIR must be set)
# =============================================================================

# PostgreSQL connection URL (bare-metal only — Docker Compose sets this automatically)
DATABASE_URL=postgres://user:password@localhost:5432/trengine?sslmode=disable

# MQTT broker URL (optional if WATCH_DIR is set)
MQTT_BROKER_URL=tcp://localhost:1883

# =============================================================================
# MQTT (optional)
# =============================================================================

# MQTT client ID (must be unique per connection)
MQTT_CLIENT_ID=tr-engine

# MQTT topic filter. Comma-separated list of MQTT topic patterns.
# Default "#" subscribes to everything (fine for dedicated brokers).
# To limit, use the prefixes from your trunk-recorder MQTT plugin config:
#   MQTT_TOPICS=myprefix/feeds/#,myprefix/units/#,myprefix/messages/#
MQTT_TOPICS=#

# MQTT credentials (leave empty if broker allows anonymous).
# In Docker all-in-one mode, these also configure the bundled Mosquitto broker —
# when set, anonymous access is disabled and authentication is required.
MQTT_USERNAME=
MQTT_PASSWORD=

# =============================================================================
# HTTP Server (optional)
# =============================================================================

# Listen address (host:port)
HTTP_ADDR=:8080

# Request timeouts
HTTP_READ_TIMEOUT=5s
HTTP_WRITE_TIMEOUT=30s
HTTP_IDLE_TIMEOUT=120s

# Set to false to disable all API authentication. When disabled, all endpoints
# are open with no token required. AUTH_TOKEN and WRITE_TOKEN are ignored.
# AUTH_ENABLED=true

# Bearer token for API authentication.
# If not set, a random token is auto-generated on each startup (logged at boot).
# Set a value here for a persistent token that survives restarts.
# Web UI pages receive the token automatically — no user prompt needed.
# AUTH_TOKEN=

# Write protection token. When set, POST/PATCH/PUT/DELETE endpoints require
# this token instead of AUTH_TOKEN. Reads still work with AUTH_TOKEN.
# If not set, all endpoints accept AUTH_TOKEN (current behavior).
#
# IMPORTANT: If your instance is accessible from the internet, you should
# ALWAYS set WRITE_TOKEN. Without it, anyone with your AUTH_TOKEN (which is
# served to every browser via /auth-init) can modify talkgroups, delete data,
# merge systems, and upload arbitrary calls. WRITE_TOKEN ensures the web UI
# stays read-only while only trusted services (trunk-recorder, scripts) can
# write.
# WRITE_TOKEN=

# Allowed CORS origins (comma-separated). Empty = allow all origins (*).
# Set this when the web UI is served from a different domain than the API.
# CORS_ORIGINS=https://example.com,https://dashboard.example.com

# Per-IP rate limiting (requests per second / burst)
# RATE_LIMIT_RPS=20
# RATE_LIMIT_BURST=40

# =============================================================================
# Application (optional)
# =============================================================================

# Directory for storing audio files (used when audio is received via MQTT)
AUDIO_DIR=./audio

# trunk-recorder audio directory (optional). When set, tr-engine can serve
# audio files directly from TR's filesystem using the call_filename stored at
# call_end. This is an alternative to receiving base64-encoded audio over MQTT.
# Point this at TR's audioBaseDir (or a mount of it).
# TR_AUDIO_DIR=/app/tr_audio

# =============================================================================
# TR Auto-Discovery (easiest setup — just point at your TR directory)
# =============================================================================

# Path to your trunk-recorder directory (the one with config.json).
# Auto-discovers captureDir (sets WATCH_DIR + TR_AUDIO_DIR), system names,
# and imports talkgroup CSVs into a browsable reference directory.
# If a docker-compose.yaml is found, container paths are auto-translated
# to host paths via the volume mappings.
# TR_DIR=/home/radio/trunk-recorder

# Write alpha_tag edits (PATCH) back to TR's talkgroup/unit CSV files on disk.
# Disabled by default — enable only if you want tr-engine to modify TR's files.
# Requires TR_DIR to be set so CSV file paths are known.
# CSV_WRITEBACK=false

# P25 system merging: when true (default), multiple TR instances monitoring
# the same P25 network (same sysid/wacn) are auto-merged into one system
# with multiple sites. Set to false to keep each instance's systems separate,
# useful when running CC-only loggers alongside full recording systems.
# MERGE_P25_SYSTEMS=true

# =============================================================================
# File Watch Mode (optional — alternative to MQTT ingest)
# =============================================================================

# Watch trunk-recorder's audio output directory for new JSON metadata files.
# When set, tr-engine ingests calls by monitoring the filesystem instead of
# (or in addition to) MQTT. MQTT_BROKER_URL becomes optional.
# Point this at TR's audioBaseDir (e.g. /home/radio/trunk-recorder/audio_files).
# WATCH_DIR=/path/to/trunk-recorder/audio_files

# Instance ID for file-watched calls (used for identity resolution)
# WATCH_INSTANCE_ID=file-watch

# Number of days to backfill on startup (0 = backfill all, -1 = no backfill)
# WATCH_BACKFILL_DAYS=7

# Instance ID for HTTP-uploaded calls (used for identity resolution)
# UPLOAD_INSTANCE_ID=http-upload

# Log level: debug, info, warn, error
LOG_LEVEL=info

# Prometheus metrics endpoint at /metrics (enabled by default).
# Exposes HTTP request latency, MQTT throughput, active calls, SSE subscribers,
# and database pool health in Prometheus text format.
# METRICS_ENABLED=true

# Update checker (enabled by default). Checks for new releases on startup and
# every hour. Shows update availability in logs, /health endpoint, and web UI.
# Set UPDATE_CHECK=false to disable all update checking.
# UPDATE_CHECK=true
# UPDATE_CHECK_URL=https://updates.luxprimatech.com/check

# =============================================================================
# S3 Audio Storage (optional — disabled when S3_BUCKET is empty)
# =============================================================================

# S3-compatible object storage for audio files (works with AWS S3, MinIO,
# Backblaze B2, Cloudflare R2, etc.). When enabled, audio is stored in S3
# with an optional local disk cache for fast serving.

# Bucket name (required to enable S3)
# S3_BUCKET=

# S3 endpoint URL (required for non-AWS providers like MinIO or B2)
# S3_ENDPOINT=https://s3.us-west-001.backblazeb2.com

# AWS region
# S3_REGION=us-east-1

# S3 credentials
# S3_ACCESS_KEY=
# S3_SECRET_KEY=

# Key prefix for all objects (e.g. "audio/" to namespace within a shared bucket)
# S3_PREFIX=

# Presigned URL expiry for client-side audio playback. When the API cannot serve
# a file from local cache, it redirects the client to a time-limited S3 URL.
# NOTE: The S3 endpoint must be reachable by API clients (browsers) for presigned
# URL redirects to work. For private/internal S3 endpoints (e.g. internal MinIO),
# clients will get a redirect they cannot follow. In that case, ensure the endpoint
# is accessible or disable presigned URLs by setting a very short expiry.
# S3_PRESIGN_EXPIRY=1h

# Keep a local disk cache of audio files for fast serving (default: true).
# When enabled, files are served from disk and only fall back to S3 on cache miss.
# S3_LOCAL_CACHE=true

# How long to keep files in the local cache before pruning (default: 30 days).
# Files are only pruned after confirming they exist in S3.
# S3_CACHE_RETENTION=720h

# Maximum local cache size in GB (0 = unlimited, only time-based retention applies)
# S3_CACHE_MAX_GB=0

# Upload mode: "async" (default) or "sync".
# async: local write returns immediately, S3 upload happens in the background.
#   A reconciler catches any missed uploads periodically.
# sync: both local and S3 writes complete before the call is considered saved.
# S3_UPLOAD_MODE=async

# Raw MQTT message archival. Messages are always processed by handlers regardless
# of these settings — this only controls storage in mqtt_raw_messages.
#
# Master switch: set to false to disable all raw archival.
RAW_STORE=true
#
# Allowlist mode (comma-separated handler names). When set, ONLY these handlers
# are archived. Use "_unknown" to capture unrecognized/malformed messages.
# Takes priority over RAW_EXCLUDE_TOPICS.
# RAW_INCLUDE_TOPICS=_unknown,call_start,call_end,audio
#
# Denylist mode (comma-separated handler names). Ignored if RAW_INCLUDE_TOPICS is set.
# Valid handler names: trunking_message, unit_event, console, recorders, rates,
#   call_start, call_end, calls_active, audio, config, status, systems, system, recorder
# RAW_EXCLUDE_TOPICS=trunking_message

# =============================================================================
# Transcription (optional — disabled when no STT provider is configured)
# =============================================================================

# STT provider: "whisper" (default) or "elevenlabs"
# Whisper requires WHISPER_URL. ElevenLabs requires ELEVENLABS_API_KEY.
# STT_PROVIDER=whisper

# Whisper-compatible speech-to-text API endpoint.
# Recommended: speaches-ai server with faster-whisper-large-v3-turbo model.
# For remote APIs (OpenAI, Groq), set WHISPER_API_KEY below.
# WHISPER_URL=http://localhost:8000/v1/audio/transcriptions

# API key for authenticated Whisper endpoints (OpenAI, Groq, etc.)
# Not needed for self-hosted servers without auth.
# WHISPER_API_KEY=

# Whisper model name (sent as the "model" field in API requests)
# WHISPER_MODEL=deepdml/faster-whisper-large-v3-turbo-ct2

# Whisper API timeout
# WHISPER_TIMEOUT=30s

# Sampling temperature (0.1 prevents hallucination loops with no quality loss)
# WHISPER_TEMPERATURE=0.1

# Language code (ISO 639-1)
# WHISPER_LANGUAGE=en

# Domain-specific prompt to steer vocabulary (limited to 224 tokens by Whisper).
# Example: "Butler County dispatch. Medic 23, Engine 7. 10-4, copy, en route."
# WHISPER_PROMPT=

# Comma-separated hotwords to boost recognition of specific terms.
# Example: "Medic,Engine,Ladder,Rescue,cul-de-sac,blow-ins,10-4"
# WHISPER_HOTWORDS=

# Beam search width (0 = server default, typically 5)
# WHISPER_BEAM_SIZE=0

# --- Anti-hallucination parameters (require custom whisper-server) ---
# These are ignored by speaches-ai but used by tools/whisper-server.

# Repetition penalty — values >1.0 penalize repeated tokens. 1.2 recommended for radio.
# WHISPER_REPETITION_PENALTY=0

# Block exact n-gram repetition. 3 = block any 3-word phrase from repeating.
# WHISPER_NO_REPEAT_NGRAM=0

# Use previous segment text as context. Set to false to prevent hallucination cascading.
# Good for short independent radio calls. Omit to use server default (true).
# WHISPER_CONDITION_ON_PREV=

# No-speech detection threshold (0 = server default ~0.6)
# WHISPER_NO_SPEECH_THRESHOLD=0

# Skip hallucinated words during silent audio sections (seconds). 0 = disabled.
# Requires word timestamps (always enabled). Recommended: 2.0 for radio audio.
# WHISPER_HALLUCINATION_THRESHOLD=0

# Maximum output tokens per segment. Hard cap to prevent runaway generation. 0 = unlimited.
# WHISPER_MAX_TOKENS=0

# Enable Silero VAD preprocessing. Generally not needed for P25 radio (already PTT-gated).
# WHISPER_VAD_FILTER=false

# Audio preprocessing with sox (bandpass 300-3000Hz + normalize).
# Removes out-of-band tones and noise that cause hallucinations.
# Requires sox in PATH.
# PREPROCESS_AUDIO=false

# Number of concurrent transcription workers
# TRANSCRIBE_WORKERS=2

# Maximum queued transcription jobs (jobs dropped when full)
# TRANSCRIBE_QUEUE_SIZE=500

# Skip calls shorter than this duration (seconds)
# TRANSCRIBE_MIN_DURATION=1.0

# Skip calls longer than this duration (seconds)
# TRANSCRIBE_MAX_DURATION=300

# =============================================================================
# ElevenLabs STT (alternative to Whisper — requires STT_PROVIDER=elevenlabs)
# =============================================================================

# ElevenLabs API key (required when STT_PROVIDER=elevenlabs)
# ELEVENLABS_API_KEY=

# ElevenLabs model: "scribe_v1" or "scribe_v2"
# ELEVENLABS_MODEL=scribe_v2

# Comma-separated key terms to boost recognition (e.g. "Medic,Engine,Ladder")
# ELEVENLABS_KEYTERMS=

# =============================================================================
# LLM Post-Processing (optional — not yet implemented)
# =============================================================================

# OpenAI-compatible chat completions endpoint for LLM correction of transcriptions.
# LLM_URL=http://localhost:11434/v1/chat/completions
# LLM_MODEL=gemma3:4b-it-qat
# LLM_TIMEOUT=30s
