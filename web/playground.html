<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="auth.js?v=1"></script>
<meta name="card-title" content="Page Builder">
<meta name="card-description" content="Generate custom dashboard pages with AI">
<meta name="card-order" content="11">
<title>Page Builder — tr-engine</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;700&family=Outfit:wght@200;300;400;600;700&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Karla:wght@200;300;400;500&family=Syne:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<script src="theme-config.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-mono);
    font-weight: var(--font-weight-body);
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    transition: background 0.5s, color 0.4s;
    -webkit-font-smoothing: antialiased;
  }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: var(--grid-bg);
    background-size: var(--grid-size) var(--grid-size);
    pointer-events: none; z-index: 0;
  }
  body::after {
    content: ''; position: fixed; inset: 0;
    background: var(--scanlines);
    pointer-events: none; z-index: 9999;
  }
  .vignette-overlay {
    position: fixed; inset: 0;
    background: var(--vignette);
    pointer-events: none; z-index: 9998;
    transition: background 0.6s;
  }
  .theme-label {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    z-index: 10000; font-family: var(--font-display); font-size: 12px;
    letter-spacing: 3px; text-transform: uppercase; color: var(--accent);
    background: color-mix(in srgb, var(--bg) 92%, transparent); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--border); padding: 10px 24px; border-radius: 100px;
    transition: all 0.5s; pointer-events: none; opacity: 0;
  }
  .theme-label.show { opacity: 1; }

  /* ── Playground Layout ── */
  .playground {
    display: flex; flex-direction: row; gap: 16px;
    padding: 16px; flex: 1; overflow: hidden;
    position: relative; z-index: 1;
  }

  .panel {
    flex: 1; display: flex; flex-direction: column; gap: 12px;
    min-width: 0;
  }

  .panel-header {
    font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.1em;
    color: var(--text-muted);
    display: flex; align-items: center; gap: 8px;
  }

  /* ── Mode Toggle ── */
  .mode-toggle {
    display: flex; border-radius: var(--radius-sm);
    overflow: hidden; border: 1px solid var(--glass-border);
    background: var(--glass-bg);
  }
  .mode-toggle button {
    flex: 1; padding: 8px 16px; cursor: pointer;
    font-family: var(--font-mono); font-size: 12px; font-weight: 500;
    background: transparent; color: var(--text-muted);
    border: none; transition: all 0.2s;
  }
  .mode-toggle button:hover { color: var(--text); }
  .mode-toggle button.active {
    background: var(--accent); color: var(--bg); font-weight: 600;
  }

  .mode-hint {
    font-size: 11px; color: var(--text-faint); line-height: 1.4;
    padding: 0 2px;
  }

  /* ── Textareas ── */
  textarea {
    background: var(--glass-bg); border: 1px solid var(--glass-border);
    font-family: var(--font-mono); font-size: 13px; color: var(--text);
    padding: 12px; border-radius: var(--radius-sm);
    resize: vertical; outline: none; transition: border-color 0.2s;
  }
  textarea:focus { border-color: var(--accent); }
  textarea::placeholder { color: var(--text-faint); }

  .description-input { min-height: 200px; flex: none; }
  .prompt-output { flex: 1; min-height: 200px; }
  .preview-input { min-height: 150px; }

  textarea.error {
    border-color: var(--danger);
    animation: shake 0.3s ease;
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
  }

  /* ── Examples ── */
  .examples {
    display: flex; gap: 8px; flex-wrap: wrap; padding: 0 2px;
  }
  .examples a {
    font-size: 11px; color: var(--accent); cursor: pointer;
    text-decoration: none; opacity: 0.7; transition: opacity 0.2s;
  }
  .examples a:hover { opacity: 1; text-decoration: underline; }

  /* ── Options ── */
  .option-row {
    display: flex; align-items: center; gap: 8px;
    padding: 0 2px;
  }
  .option-row input[type="checkbox"] {
    accent-color: var(--accent);
    width: 14px; height: 14px; cursor: pointer;
  }
  .option-row label {
    font-size: 12px; color: var(--text-mid); cursor: pointer;
  }
  .option-hint {
    font-size: 10px; color: var(--text-faint); line-height: 1.3;
    padding: 0 2px 0 22px;
  }

  /* ── Buttons ── */
  .btn {
    background: var(--glass-bg); border: 1px solid var(--accent);
    color: var(--accent); padding: 10px 20px;
    cursor: pointer; font-family: var(--font-mono);
    font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.1em;
    border-radius: var(--radius-sm); transition: all 0.2s;
  }
  .btn:hover {
    background: var(--accent); color: var(--bg);
    box-shadow: 0 0 20px var(--accent-glow);
  }

  .btn-copy {
    font-size: 10px; padding: 3px 10px;
    background: var(--glass-bg); border: 1px solid var(--border);
    color: var(--text-muted); cursor: pointer;
    font-family: var(--font-mono); text-transform: uppercase;
    letter-spacing: 0.05em; border-radius: var(--radius-sm);
    transition: all 0.2s; margin-left: auto;
  }
  .btn-copy:hover { border-color: var(--accent); color: var(--accent); }

  /* ── Preview Frame ── */
  .preview-frame {
    border: 1px solid var(--border); border-radius: var(--radius-sm);
    background: #fff; min-height: 300px; flex: 1;
  }

  /* ── Responsive ── */
  @media (max-width: 768px) {
    .playground {
      flex-direction: column; overflow-y: auto;
      padding: 12px;
    }
    .description-input { min-height: 150px; }
    .prompt-output { min-height: 150px; }
    .preview-input { min-height: 120px; }
    .preview-frame { min-height: 250px; }
  }
</style>
</head>
<body>

<div class="vignette-overlay"></div>
<div class="theme-label" id="themeLabel"></div>

<div class="playground">
  <!-- Left Panel: Builder -->
  <div class="panel">
    <div class="panel-header">Describe Your Page</div>
    <textarea class="description-input" id="description"
      placeholder="A live dashboard showing active calls with auto-refresh, audio playback buttons, and a chart of calls per hour by talkgroup..."></textarea>
    <div class="examples">
      <span style="color:var(--text-faint);font-size:11px">Try:</span>
      <a href="#" data-example="livefeed">Live call feed</a>
      <a href="#" data-example="leaderboard">Talkgroup leaderboard</a>
      <a href="#" data-example="unittracker">Unit activity tracker</a>
    </div>
    <div class="panel-header">Mode</div>
    <div class="mode-toggle">
      <button class="active" data-mode="integrated">Integrated</button>
      <button data-mode="standalone">Standalone</button>
    </div>
    <div class="mode-hint" id="modeHint">
      Page lives in tr-engine's web/ directory. Uses theme system and auto-auth.
    </div>
    <div class="option-row">
      <input type="checkbox" id="includeToken">
      <label for="includeToken">Include connection info for live preview</label>
    </div>
    <div class="option-hint" id="tokenHint" style="display:none">
      Adds this instance's URL and auth token so the AI-generated page works immediately in the preview.
    </div>
    <button class="btn" id="buildBtn">Build Prompt</button>
  </div>

  <!-- Right Panel: Output -->
  <div class="panel">
    <div class="panel-header">
      Generated Prompt
      <button class="btn-copy" id="copyBtn" style="display:none">Copy</button>
    </div>
    <textarea class="prompt-output" id="promptOutput" readonly
      placeholder="Click 'Build Prompt' to generate..."></textarea>
    <div class="panel-header">Preview (paste AI response here)</div>
    <textarea class="preview-input" id="previewInput"
      placeholder="Paste the HTML that Claude generates..."></textarea>
    <button class="btn" id="renderBtn">Render Preview</button>
    <iframe class="preview-frame" id="previewFrame" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>
</div>

<script src="theme-engine.js?v=2"></script>

<script>
(function() {
  'use strict';

  // ── Elements ──
  const descriptionEl = document.getElementById('description');
  const promptOutput = document.getElementById('promptOutput');
  const previewInput = document.getElementById('previewInput');
  const previewFrame = document.getElementById('previewFrame');
  const buildBtn = document.getElementById('buildBtn');
  const copyBtn = document.getElementById('copyBtn');
  const renderBtn = document.getElementById('renderBtn');
  const modeHint = document.getElementById('modeHint');
  const modeToggle = document.querySelector('.mode-toggle');
  const includeTokenEl = document.getElementById('includeToken');
  const tokenHint = document.getElementById('tokenHint');

  let currentMode = 'integrated';

  // ── Mode Hints ──
  const MODE_HINTS = {
    integrated: "Page lives in tr-engine's web/ directory. Uses theme system and auto-auth.",
    standalone: "Self-contained HTML file. Works from anywhere — just needs the API URL."
  };

  // ── Example Descriptions ──
  const EXAMPLES = {
    livefeed: "A live dashboard showing incoming calls via SSE. Each call shows talkgroup name, duration, unit count, and a play button for audio. Auto-scrolls as new calls arrive. Include a pause button to stop auto-scroll.",
    leaderboard: "A leaderboard showing the busiest talkgroups in the last hour. Horizontal bar chart with talkgroup names on the y-axis and call count on the x-axis. Auto-refreshes every 60 seconds. Use Chart.js via CDN.",
    unittracker: "A grid of unit cards showing all active units. Each card shows unit ID, alpha tag, last event type with a colored badge, and the talkgroup they're on. Updates live via SSE. Cards pulse briefly when their unit has new activity."
  };

  // ── Prompt Templates ──
  const INTEGRATED_TEMPLATE = `Build a single-file HTML page that will be served from tr-engine's web/ directory.

## API Specification
Read the full API spec here: https://raw.githubusercontent.com/LumenPrima/tr-engine/master/openapi.yaml

Use any endpoints you need. All endpoints are under /api/v1. Responses use {items, total, limit, offset} pagination.

## Authentication
Include this as the FIRST script in <head>:
<script src="auth.js?v=1"><\/script>

This automatically patches fetch() and EventSource to include auth headers. No manual auth code needed — just use fetch('/api/v1/...') normally.

## Theme System
Include these scripts:
<script src="theme-config.js"><\/script>  (in <head>, after auth.js)
<script src="theme-engine.js?v=2"><\/script>  (before </body>)

The theme engine injects a sticky header with nav and theme switcher. Use these CSS variables for styling:

Background: --bg, --bg-surface, --bg-elevated, --bg-tile
Text: --text, --text-mid, --text-muted, --text-faint
Accent: --accent, --accent-light, --accent-dim, --accent-glow
Status: --success, --warning, --danger, --info
Glass: --glass-bg, --glass-border, --glass-shine, --glass-blur
Typography: --font-display, --font-body, --font-mono
Borders: --border, --border-hover, --radius, --radius-sm
Shadows: --shadow-panel, --shadow-panel-hover

## Page Registration
Add these meta tags so the page appears in tr-engine's nav:
<meta name="card-title" content="YOUR PAGE TITLE">
<meta name="card-description" content="Short description">

## SSE Real-Time Events
For live updates, connect to /api/v1/events/stream with filter params:
const es = new EventSource('/api/v1/events/stream?types=call_start,call_end');
es.onmessage = (e) => { const data = JSON.parse(e.data); /* handle event */ };

Filter options: systems, sites, tgids, units, types, emergency_only (all optional, AND-ed).
Event types: call_start, call_end, unit_event, recorder_update, rate_update

## What to Build
{DESCRIPTION}`;

  const STANDALONE_TEMPLATE = `Build a self-contained single-file HTML page that connects to a tr-engine REST API instance.

## API Specification
Read the full API spec here: https://raw.githubusercontent.com/LumenPrima/tr-engine/master/openapi.yaml

Use any endpoints you need. All endpoints are under /api/v1. Responses use {items, total, limit, offset} pagination.

## Authentication
The page needs to connect to a tr-engine instance. Include this auth bootstrap at the top of the page:

1. Show a config bar with an API URL input (default: window.location.origin) and a "Connect" button
2. On connect, fetch {apiUrl}/api/v1/auth-init to get the Bearer token (this endpoint requires no auth)
3. If successful, store the token and show a green connected indicator
4. If it fails (CORS or network), show a manual "Auth Token" input field as fallback
5. Create a helper function that wraps fetch to include the Authorization header:

function apiFetch(path, opts = {}) {
  return fetch(API_URL + path, {
    ...opts,
    headers: { ...opts.headers, 'Authorization': 'Bearer ' + TOKEN }
  });
}

Use apiFetch('/api/v1/...') for all API calls.

## SSE Real-Time Events
For live updates:
const url = API_URL + '/api/v1/events/stream?types=call_start,call_end&token=' + encodeURIComponent(TOKEN);
const es = new EventSource(url);
es.onmessage = (e) => { const data = JSON.parse(e.data); /* handle event */ };

## Styling
Use a clean, modern dark theme. No external CSS frameworks needed — inline styles are fine.
Suggested palette: #0a0a0f background, #e0e0e8 text, #00d4ff accent.

## What to Build
{DESCRIPTION}`;

  // ── Mode Toggle ──
  modeToggle.addEventListener('click', function(e) {
    const btn = e.target.closest('button[data-mode]');
    if (!btn) return;
    modeToggle.querySelector('.active').classList.remove('active');
    btn.classList.add('active');
    currentMode = btn.dataset.mode;
    modeHint.textContent = MODE_HINTS[currentMode];
    updateURL();
  });

  // ── Token Checkbox ──
  includeTokenEl.addEventListener('change', function() {
    tokenHint.style.display = includeTokenEl.checked ? '' : 'none';
  });

  // ── Example Links ──
  document.querySelector('.examples').addEventListener('click', function(e) {
    const link = e.target.closest('a[data-example]');
    if (!link) return;
    e.preventDefault();
    descriptionEl.value = EXAMPLES[link.dataset.example];
    descriptionEl.classList.remove('error');
    updateURL();
  });

  // ── Build Prompt ──
  function getConnectionBlock() {
    if (!includeTokenEl.checked) return '';
    var token = window.trAuth && window.trAuth.getToken ? window.trAuth.getToken() : null;
    if (!token) return '';
    var baseUrl = location.origin;
    return '\n\n## Live Instance (for testing)\n' +
      'API base URL: ' + baseUrl + '\n' +
      'Auth token: ' + token + '\n' +
      (currentMode === 'integrated'
        ? 'The page will be served from this instance, so relative URLs work. Auth is handled by auth.js automatically.'
        : 'Pre-configure the page to connect to this instance on load:\n' +
          '- Set API_URL = \'' + baseUrl + '\'\n' +
          '- Set TOKEN = \'' + token + '\'\n' +
          '- Skip the connection UI and go straight to showing data.');
  }

  buildBtn.addEventListener('click', function() {
    const desc = descriptionEl.value.trim();
    if (!desc) {
      descriptionEl.classList.add('error');
      setTimeout(function() { descriptionEl.classList.remove('error'); }, 600);
      return;
    }
    const template = currentMode === 'integrated' ? INTEGRATED_TEMPLATE : STANDALONE_TEMPLATE;
    promptOutput.value = template.replace('{DESCRIPTION}', desc) + getConnectionBlock();
    copyBtn.style.display = '';
    promptOutput.select();
  });

  // ── Copy ──
  copyBtn.addEventListener('click', function() {
    navigator.clipboard.writeText(promptOutput.value).then(function() {
      copyBtn.textContent = 'Copied!';
      setTimeout(function() { copyBtn.textContent = 'Copy'; }, 1500);
    });
  });

  // ── Render Preview ──
  renderBtn.addEventListener('click', function() {
    const html = previewInput.value.trim();
    if (!html) {
      previewInput.classList.add('error');
      setTimeout(function() { previewInput.classList.remove('error'); }, 600);
      return;
    }
    previewFrame.srcdoc = html;
    previewFrame.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });

  // ── URL State ──
  function updateURL() {
    const params = new URLSearchParams();
    if (currentMode !== 'integrated') params.set('mode', currentMode);
    const desc = descriptionEl.value.trim();
    if (desc) params.set('desc', desc);
    const qs = params.toString();
    history.replaceState(null, '', qs ? '?' + qs : location.pathname);
  }

  function restoreURL() {
    const params = new URLSearchParams(location.search);
    const mode = params.get('mode');
    if (mode === 'standalone') {
      modeToggle.querySelector('.active').classList.remove('active');
      modeToggle.querySelector('[data-mode="standalone"]').classList.add('active');
      currentMode = 'standalone';
      modeHint.textContent = MODE_HINTS.standalone;
    }
    const desc = params.get('desc');
    if (desc) descriptionEl.value = desc;
  }

  descriptionEl.addEventListener('input', function() {
    descriptionEl.classList.remove('error');
    updateURL();
  });

  restoreURL();
})();
</script>
</body>
</html>
